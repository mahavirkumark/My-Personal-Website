
<script>
  // ** Core Application Logic **

  // Firebase Configuration
  const firebaseConfig = {
    apiKey: "AIzaSyB78RTVCg0cmSPp7A1RJyyAgBuCeolO0cc",
    authDomain: "sk12-58e9e.firebaseapp.com",
    databaseURL: "https://sk12-58e9e-default-rtdb.firebaseio.com",
    projectId: "sk12-58e9e",
    storageBucket: "sk12-58e9e.appspot.com",
    messagingSenderId: "470207874652",
    appId: "1:470207874652:web:67ba1cf3629b7e5b144899"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();
  let currentUser = null;

  // Function to save a new credential
  const saveCredential = (isMobile = false) => {
    const titleId = isMobile ? "title-m" : "title";
    const emailId = isMobile ? "email-m" : "email";
    const usernameId = isMobile ? "username-m" : "username";
    const passwordId = isMobile ? "password-m" : "password";
    const saveBtnId = isMobile ? "save-btn-m" : "save-btn";
    const messageId = isMobile ? "save-message-m" : "save-message";

    const title = document.getElementById(titleId)?.value.trim();
    const email = document.getElementById(emailId)?.value.trim();
    const username = document.getElementById(usernameId)?.value.trim();
    const password = document.getElementById(passwordId)?.value.trim();
    const saveBtn = document.getElementById(saveBtnId);
    const saveMessage = document.getElementById(messageId);

    if (!title) {
      alert("App/Website title is required!");
      return;
    }
    
    // Show saving state
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Saving...';
    saveBtn.disabled = true;

    const id = Date.now().toString();
    db.ref(`users/${currentUser.uid}/credentials/${id}`).set({ title, email, username, password })
      .then(() => {
        // Show success message and reset button
        saveMessage.classList.remove("hidden");
        saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i> Save Credential';
        saveBtn.disabled = false;
        
        // Hide message and clear fields after a delay
        setTimeout(() => {
          saveMessage.classList.add("hidden");
          const inputIds = [titleId, emailId, usernameId, passwordId];
          inputIds.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = "";
          });
          document.getElementById(titleId)?.focus();
        }, 2000);
      })
      .catch((error) => {
        console.error("Error saving credential:", error);
        alert("Failed to save credential. Please try again.");
        saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i> Save Credential';
        saveBtn.disabled = false;
      });
  };

  // Function to load all user credentials (visible by default)
const loadCredentials = () => {
  const desktopList = document.getElementById("cred-list");
  const mobileList = document.getElementById("cred-list-mobile");
  
  if (desktopList) desktopList.innerHTML = `<p class="text-gray-500">Loading...</p>`;
  if (mobileList) mobileList.innerHTML = `<p class="text-gray-500">Loading...</p>`;

  db.ref(`users/${currentUser.uid}/credentials`).on("value", snapshot => {
    if (desktopList) desktopList.innerHTML = "";
    if (mobileList) mobileList.innerHTML = "";

    if (!snapshot.exists()) {
      const noCredsMessage = `<p class="text-gray-500">No credentials found.</p>`;
      if (desktopList) desktopList.innerHTML = noCredsMessage;
      if (mobileList) mobileList.innerHTML = noCredsMessage;
      return;
    }

    snapshot.forEach(child => {
      const data = child.val();
      const id = child.key;
      const safeData = encodeURIComponent(JSON.stringify(data));

      const html = `
        <div class="password-item border p-4 rounded shadow bg-gray-50 flex flex-col" data-id="${id}">
          <h3 class="website-name font-semibold text-lg text-black mb-2">${data.title || "Untitled"}</h3>
          
          ${data.email ? `
            <p class="text-sm text-gray-600 flex items-center justify-between mb-1">
              <span>Email: <span class="cred-value email-value" data-original="${data.email}">${data.email}</span></span>
              <span class="flex items-center gap-1">
                <button onclick="toggleVisibility(this)" class="text-gray-500 hover:text-gray-900 text-sm">
                  <i class="fas fa-eye-slash"></i>
                </button>
                <button onclick="copyToClipboard('${data.email}', this)" class="px-2 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700">Copy</button>
              </span>
            </p>` : ''}

          ${data.username ? `
            <p class="text-sm text-gray-600 flex items-center justify-between mb-1">
              <span>Username: <span class="cred-value username-value" data-original="${data.username}">${data.username}</span></span>
              <span class="flex items-center gap-1">
                <button onclick="toggleVisibility(this)" class="text-gray-500 hover:text-gray-900 text-sm">
                  <i class="fas fa-eye-slash"></i>
                </button>
                <button onclick="copyToClipboard('${data.username}', this)" class="px-2 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700">Copy</button>
              </span>
            </p>` : ''}

          ${data.password ? `
            <p class="text-sm text-gray-600 flex items-center justify-between mb-1">
              <span>Password: <span class="cred-value password-value" data-original="${data.password}">${data.password}</span></span>
              <span class="flex items-center gap-1">
                <button onclick="toggleVisibility(this)" class="text-gray-500 hover:text-gray-900 text-sm">
                  <i class="fas fa-eye-slash"></i>
                </button>
                <button onclick="copyToClipboard('${data.password}', this)" class="px-2 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700">Copy</button>
              </span>
            </p>` : ''}

          <div class="mt-3 flex gap-3 justify-start">
            <button onclick="editCredential('${id}', '${safeData}')" class="text-blue-600 hover:underline"><i class="fas fa-edit mr-1"></i>Edit</button>
            <button onclick="deleteCredential('${id}')" class="text-red-600 hover:underline"><i class="fas fa-trash mr-1"></i>Delete</button>
            <button onclick="shareCredential('${data.title}', '${data.email || ''}', '${data.username || ''}', '${data.password || ''}')" class="text-green-600 hover:underline">
              <i class="fas fa-share-alt mr-1"></i>Share
            </button>
          </div>
        </div>
      `;
      
      if (desktopList) desktopList.innerHTML += html;
      if (mobileList) mobileList.innerHTML += html;
    });

    filterPasswords();
    filterPasswordsMobile();
  });
};


  // ** UI Interactions and Utility Functions **

  // Copy function with visual feedback
  const copyToClipboard = (text, button) => {
    navigator.clipboard.writeText(text).then(() => {
      const originalText = "Copy";
      const newText = "Copied!";
      
      button.innerText = newText;
      button.disabled = true;
      button.classList.remove("bg-blue-600");
      button.classList.add("bg-green-600");
      button.style.transform = "scale(1.1)";
      button.style.transition = "all 0.2s ease-in-out";

      setTimeout(() => {
        button.innerText = originalText;
        button.disabled = false;
        button.classList.remove("bg-green-600");
        button.classList.add("bg-blue-600");
        button.style.transform = "scale(1)";
      }, 1500);
    });
  };

  // Toggle visibility of a credential field
  const toggleVisibility = (button) => {
    const parent = button.closest("p");
    if (!parent) return;

    const valueSpan = parent.querySelector(".cred-value");
    const isHidden = valueSpan.textContent === "••••••••";

    if (isHidden) {
      valueSpan.textContent = valueSpan.getAttribute("data-original");
      button.innerHTML = `<i class="fas fa-eye"></i>`;
      button.classList.remove("text-gray-500");
      button.classList.add("text-blue-600");
    } else {
      valueSpan.textContent = "••••••••";
      button.innerHTML = `<i class="fas fa-eye-slash"></i>`;
      button.classList.remove("text-blue-600");
      button.classList.add("text-gray-500");
    }
  };

  // Edit a credential
  const editCredential = (id, encoded) => {
    const data = JSON.parse(decodeURIComponent(encoded));
    const newTitle = prompt("Edit Title:", data.title || "");
    const newEmail = prompt("Edit Email:", data.email || "");
    const newUsername = prompt("Edit Username:", data.username || "");
    const newPassword = prompt("Edit Password:", data.password || "");

    if (newTitle !== null) {
      db.ref(`users/${currentUser.uid}/credentials/${id}`).set({
        title: newTitle,
        email: newEmail || "",
        username: newUsername || "",
        password: newPassword || ""
      });
    }
  };

  // Delete a credential
  const deleteCredential = (id) => {
    if (confirm("Are you sure you want to delete this credential?")) {
      db.ref(`users/${currentUser.uid}/credentials/${id}`).remove();
    }
  };

  // Share a credential using the Web Share API
  const shareCredential = (title, email, username, password) => {
    let shareText = `Website/App: ${title}\n`;
    if (email) shareText += `Email: ${email}\n`;
    if (username) shareText += `Username: ${username}\n`;
    if (password) shareText += `Password: ${password}\n`;

    if (navigator.share) {
      navigator.share({
        title: `Credential for ${title}`,
        text: shareText
      }).then(() => {
        console.log('Successfully shared!');
      }).catch((error) => {
        console.error('Error sharing:', error);
        alert("Sharing failed. Please try again.");
      });
    } else {
      alert("Sharing is not supported on this browser.");
    }
  };

  // Search function for desktop
  const filterPasswords = () => {
    const query = document.getElementById("searchInput")?.value.toLowerCase() || "";
    document.querySelectorAll("#cred-list .password-item").forEach(item => {
      const website = item.querySelector(".website-name")?.textContent.toLowerCase() || "";
      item.style.display = website.includes(query) ? "block" : "none";
    });
  };

  // Search function for mobile
  const filterPasswordsMobile = () => {
    const query = document.getElementById("searchInputMobile")?.value.toLowerCase() || "";
    document.querySelectorAll("#cred-list-mobile .password-item").forEach(item => {
      const website = item.querySelector(".website-name")?.textContent.toLowerCase() || "";
      item.style.display = website.includes(query) ? "block" : "none";
    });
  };
  
  // Mobile menu toggle
  const mobileMenuBtn = document.getElementById("menu-btn");
  const mobileMenu = document.getElementById("mobile-menu");
  if (mobileMenuBtn && mobileMenu) {
    mobileMenuBtn.addEventListener("click", () => mobileMenu.classList.toggle("hidden"));
  }

  // Mobile profile toggle
  const mobileProfileBtn = document.getElementById("mobileProfileBtn");
  const mobileProfilePanel = document.getElementById("mobileProfilePanel");
  const mobileProfileChevron = document.getElementById("mobileProfileChevron");
  if (mobileProfileBtn && mobileProfilePanel && mobileProfileChevron) {
    mobileProfileBtn.addEventListener("click", () => {
      mobileProfilePanel.classList.toggle("hidden");
      mobileProfileChevron.classList.toggle("rotate-180");
    });
  }

  // ** Event Listeners and Authentication **

  // Save button click handlers
  const saveBtn = document.getElementById("save-btn");
  if (saveBtn) saveBtn.addEventListener("click", () => saveCredential(false));

  const saveBtnMobile = document.getElementById("save-btn-m");
  if (saveBtnMobile) saveBtnMobile.addEventListener("click", () => saveCredential(true));

  // Auth state listener
  auth.onAuthStateChanged(user => {
    if (user) {
      currentUser = user;
      
      // Update desktop profile UI
      document.getElementById("user-name").innerText = user.displayName || "User";
      document.getElementById("user-email").innerText = user.email || "";
      document.getElementById("user-pic").src = user.photoURL || "https://via.placeholder.com/40";
      
      // Update mobile profile UI
      const mobileName = document.getElementById("mobileUserName");
      const mobileEmail = document.getElementById("mobileUserEmail");
      if (mobileName) mobileName.innerText = user.displayName || "User";
      if (mobileEmail) mobileEmail.innerText = user.email || "";
      
      loadCredentials();
    } else {
      // Redirect to login page if not authenticated
      location.href = "index.html";
    }
  });

  // Logout button click handlers
  const logoutBtn = document.getElementById("logout-btn");
  if (logoutBtn) logoutBtn.addEventListener("click", () => auth.signOut());
  const mobileLogout = document.getElementById("mobileLogout");
  if (mobileLogout) mobileLogout.addEventListener("click", () => auth.signOut());

  // Search input listeners
  document.getElementById("searchInput")?.addEventListener("input", filterPasswords);
  document.getElementById("searchInputMobile")?.addEventListener("input", filterPasswordsMobile);


async function decryptData(encryptedBase64, keyBase64, ivBase64) {
  const key = await crypto.subtle.importKey(
    "raw",
    Uint8Array.from(atob(keyBase64), c => c.charCodeAt(0)),
    { name: "AES-GCM" },
    false,
    ["decrypt"]
  );

  const decrypted = await crypto.subtle.decrypt(
    { name: "AES-GCM", iv: Uint8Array.from(atob(ivBase64), c => c.charCodeAt(0)) },
    key,
    Uint8Array.from(atob(encryptedBase64), c => c.charCodeAt(0))
  );

  return new TextDecoder().decode(decrypted);
}


</script>































