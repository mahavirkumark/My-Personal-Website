<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Credential Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* Animations */
        .fade-in { opacity: 0; transform: translateY(20px); animation: fadeInUp 0.8s forwards; }
        .slide-left { opacity: 0; transform: translateX(-20px); animation: slideLeft 0.8s forwards; }
        .slide-right { opacity: 0; transform: translateX(20px); animation: slideRight 0.8s forwards; }

        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
        @keyframes slideLeft { to { opacity: 1; transform: translateX(0); } }
        @keyframes slideRight { to { opacity: 1; transform: translateX(0); } }

        nav a { transition: transform 0.3s, color 0.3s; }
        nav a:hover { transform: translateY(-2px); color: #3b82f6; }

        /* Ensure scrollable area looks clean */
        #cred-list::-webkit-scrollbar { width: 8px; }
        #cred-list::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }

        /* Custom style for the full-screen search overlay */
        .full-search-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white; 
            z-index: 50; 
            overflow-y: auto;
            display: none; 
        }
        
        /* Custom Logout Button Size */
        .logout-btn-circle {
            width: 80px; 
            height: 44px; 
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50px; 
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s;
        }

        /* Styles for custom field swap */
        .select-group {
            position: relative;
            flex-basis: 40%;
            min-width: 100px;
        }
        .input-group {
            flex-basis: 60%;
            display: flex;
            align-items: center;
        }
        /* FIX: Ensure the input covers the select when swapped, height: 100% is crucial for alignment */
        .select-group > input.swapped-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-700 font-sans">

    <div id="mobile-search-overlay" class="full-search-overlay">
        <header class="bg-white shadow-md p-4 flex items-center gap-3">
            <button id="close-search-btn" class="text-gray-700 hover:text-red-500 text-xl p-2 rounded-lg focus:outline-none">
                <i class="fas fa-arrow-left"></i>
            </button>
            <input type="text" id="searchInputMobileOverlay" placeholder="ðŸ” Search your passwords..." class="w-full px-3 py-2 border border-gray-400 rounded-full shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm font-medium transition" />
        </header>
        <div id="cred-list-mobile-overlay" class="p-4 space-y-4 grid sm:grid-cols-1 gap-4">
            </div>
    </div>


    <div class="hidden md:block fade-in">
        <header class="bg-white shadow-md p-4 flex justify-between items-center">
            <div class="flex items-center gap-3 slide-left">
                <i class="fas fa-user-circle text-3xl text-blue-500"></i>
                <h1 class="text-2xl font-bold text-black">My Personal Website</h1>
            </div>

            <nav class="flex items-center gap-6 text-lg">
                <a href="home.html" class="flex items-center" style="gap: 3px;"><i class="fas fa-house text-xl"></i> Home</a>
                <a href="income.html" class="flex items-center" style="gap: 3px;"><i class="fas fa-wallet text-xl"></i> Income</a>
                <a href="links.html" class="flex items-center" style="gap: 3px;"><i class="fas fa-link text-xl"></i> Links</a>
                <a href="calendar.html" class="flex items-center" style="gap: 3px;"><i class="fas fa-calendar-days text-xl"></i> Calendar</a>
                <a href="birthday.html" class="flex items-center" style="gap: 3px;"><i class="fas fa-cake-candles text-xl"></i> Birthday</a>
                <a href="password.html" class="flex items-center" style="gap: 3px;"><i class="fas fa-lock text-xl"></i> Passwords</a>
            </nav>

            <div class="flex items-center gap-4 slide-right">
                <div class="text-right">
                    <p id="user-name" class="font-medium text-black text-base">User Name</p>
                    <p id="user-email" class="text-sm text-gray-500">user@example.com</p>
                </div>
                <img id="user-pic" src="https://via.placeholder.com/100" alt="User Photo" class="w-12 h-12 rounded-full border" />
                
                <button id="logout-btn" class="bg-red-500 text-white hover:bg-red-600 logout-btn-circle">
                    Logout
                </button>
            </div>
        </header>

        <div class="w-full px-6 mx-auto mt-4 grid grid-cols-1 md:grid-cols-3 gap-4 max-w-screen-2xl">
            <div class="bg-white rounded-xl shadow-xl p-5 flex flex-col space-y-2 md:col-span-1 fade-in transition duration-300 hover:shadow-2xl">
                <h2 id="form-title" class="text-lg font-semibold mb-1 text-center text-gray-800">Add New Credential</h2>
                <input type="hidden" id="credential-id-desktop" value="" /> 

                <input id="title" class="border px-3 py-2 rounded text-sm focus:ring-blue-500 focus:border-blue-500" placeholder="App / Web / Service / Product Name (Optional)" />
                <input id="email" class="border px-3 py-2 rounded text-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Email (Optional)" />
                <input id="username" class="border px-3 py-2 rounded text-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Username (Optional)" />
                <input id="password" class="border px-3 py-2 rounded text-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Password (Optional)" />

                <div id="custom-fields-container">
                    </div>

                <button id="add-custom-field-btn" type="button" class="text-sm py-2 rounded border border-blue-900 text-blue-900 hover:bg-blue-100 transition">
                    <i class="fas fa-plus mr-2"></i> Add Custom Field (5 max)
                </button>

                <button id="save-btn" class="bg-blue-900 text-white text-sm py-2 rounded hover:bg-blue-800 mt-2 transition duration-150">
                    <i class="fas fa-save mr-2"></i> Save Credential
                </button>
                <button id="cancel-edit-btn" class="bg-gray-500 text-white text-sm py-2 rounded hover:bg-gray-600 mt-1 hidden transition duration-150">
                    <i class="fas fa-times mr-2"></i> Cancel Edit
                </button>
                <p id="save-message" class="text-center text-sm text-green-600 font-medium hidden">Credential saved!</p>
            </div>

            <div class="bg-white rounded-xl shadow-xl p-6 flex flex-col space-y-4 md:col-span-2 fade-in transition duration-300 hover:shadow-2xl">
                <h2 class="text-lg font-semibold text-center text-gray-800">Saved Credentials</h2>
                <div class="flex justify-center">
                    <input type="text" id="searchInput" placeholder="ðŸ” Search your passwords..." class="w-full max-w-2xl px-5 py-4 border border-gray-300 rounded-full shadow-inner focus:outline-none focus:ring-2 focus:ring-blue-500 text-[18px] font-bold transition" />
                </div>
                <div id="cred-list" class="grid sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-[65vh] overflow-y-auto"></div>
            </div>
        </div>
    </div>

    <div class="block md:hidden fade-in">
        <header class="bg-white shadow-md">
            <div class="flex justify-between items-center py-2 px-4">
                <div class="flex items-center gap-2 slide-left">
                    <i class="fas fa-user-circle text-2xl text-blue-500"></i>
                    <h1 class="text-lg font-bold text-black">My Personal Website</h1>
                </div>
                <button id="menu-btn" class="text-gray-700 hover:text-blue-500 focus:outline-none p-2 rounded-lg">
                    <i class="fas fa-bars text-xl"></i>
                </button>
            </div>
        </header>

        <nav id="mobile-menu" class="hidden bg-white px-6 pb-6 space-y-3 text-base font-normal text-gray-800 rounded-b shadow-md">
            <a href="home.html" class="flex items-center rounded hover:bg-gray-100 text-lg" style="gap: 5px;"><i class="fas fa-house text-xl"></i> Home</a>
            <a href="income.html" class="flex items-center" style="gap: 5px;"><i class="fas fa-wallet text-xl"></i> Income</a>
            <a href="links.html" class="flex items-center" style="gap: 5px;"><i class="fas fa-link text-xl"></i> Links</a>
            <a href="calender.html" class="flex items-center" style="gap: 5px;"><i class="fas fa-calendar-days text-xl"></i> Calendar</a>
            <a href="password.html" class="flex items-center" style="gap: 5px;"><i class="fas fa-lock text-xl"></i> Passwords</a>

            <button id="mobileLogout" class="w-full mt-2 bg-red-500 text-white hover:bg-red-600 logout-btn-circle mx-auto">
                Logout
            </button>
        </nav>

        <div class="bg-white rounded-xl shadow-xl p-4 mx-2 my-6 flex flex-col space-y-6 fade-in transition duration-300 hover:shadow-2xl">
            <div class="bg-white rounded-lg shadow-inner p-4 space-y-3 w-full">
                <h3 id="form-title-m" class="text-lg font-semibold mb-2 text-center text-gray-700">Add New Credential</h3>
                <input type="hidden" id="credential-id-mobile" value="" />

                <input id="title-m" class="border px-3 py-2 rounded text-sm w-full focus:ring-2 focus:ring-blue-500" placeholder="App / Web / Service / Product Name (Optional)" />
                <input id="email-m" class="border px-3 py-2 rounded text-sm w-full focus:ring-2 focus:ring-blue-500" placeholder="Email (Optional)" />
                <input id="username-m" class="border px-3 py-2 rounded text-sm w-full focus:ring-2 focus:ring-blue-500" placeholder="Username (Optional)" />
                <input id="password-m" class="border px-3 py-2 rounded text-sm w-full focus:ring-2 focus:ring-blue-500" placeholder="Password (Optional)" />

                <div id="custom-fields-container-m">
                    </div>

                <button id="add-custom-field-btn-m" type="button" class="text-sm py-2 rounded border border-blue-700 text-blue-700 hover:bg-blue-100 mt-1 w-full flex justify-center items-center font-medium transition">
                    <i class="fas fa-plus mr-2"></i> Add Custom Field (5 max)
                </button>

                <button id="save-btn-m" class="bg-blue-700 text-white text-sm py-2 rounded hover:bg-blue-600 mt-2 w-full flex justify-center items-center font-medium transition">
                    <i class="fas fa-save mr-2"></i> Save Credential
                </button>
                <button id="cancel-edit-btn-m" class="bg-gray-500 text-white text-sm py-2 rounded hover:bg-gray-600 mt-1 w-full flex justify-center items-center font-medium transition hidden">
                    <i class="fas fa-times mr-2"></i> Cancel Edit
                </button>
                <p id="save-message-m" class="text-center text-sm text-green-600 font-medium hidden">Credential saved!</p>
            </div>

            <input type="text" id="searchInputMobile" placeholder="ðŸ” Search your passwords..." class="w-full px-3 py-2 border border-gray-400 rounded-full shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm font-medium transition" readonly />
            <h2 class="text-lg font-semibold text-center">Saved Credentials</h2>
            <div id="cred-list-mobile" class="grid sm:grid-cols-1 gap-4"></div>
        </div>
    </div>

    <footer class="mt-12 pt-3 pb-3 bg-white text-gray-600 text-center text-sm border-t">
        &copy; 2025 Personal Website | All rights reserved
    </footer>

    <script>
        // NOTE: Replace these with your actual Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB78RTVCg0cmSPp7A1RJyyAgBuCeolO0cc", // Placeholder
            authDomain: "sk12-58e9e.firebaseapp.com", // Placeholder
            databaseURL: "https://sk12-58e9e-default-rtdb.firebaseio.com", // Placeholder
            projectId: "sk12-58e9e",
            storageBucket: "sk12-58e9e.appspot.com",
            messagingSenderId: "470207874652",
            appId: "1:470207874652:web:67ba1cf3629b7e5b144899"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        let currentUser = null;

        // --- Custom Fields Configuration (120 Options - Alphabetized) ---
        const CUSTOM_FIELD_OPTIONS = [
            "Aadhaar", 
            "Account Name", 
            "Account No", 
            "Address", 
            "Amount", 
            "API Token", 
            "Apartment Security Code", 
            "ATM PIN", 
            "Bank Account No", 
            "Bank Routing Number", 
            "Billing Address", 
            "Building Name", 
            "Broadband Acc No", 
            "Client ID", 
            "Client Secret", 
            "Cloud API Key", 
            "Consumer No", 
            "Container ID", 
            "Credit Card CVV", 
            "Credit Card Number", 
            "Customer No", 
            "Customer Support PIN", 
            "Database Schema", 
            "Date of Birth", 
            "Debit Card Number", 
            "Demant Account No", 
            "Device Serial No", 
            "Digital Certificate", 
            "Digital Wallet Address", 
            "Domain Name", 
            "Driver's License", 
            "DTH Customer ID", 
            "Electricity Bill Acc No", 
            "Employee ID", 
            "Encryption Key", 
            "Expiry Date", 
            "FTP Host", 
            "Gas Connection ID", 
            "Gold Weight/Details", 
            "Hardware Serial", 
            "Health ID", 
            "House/Flat Number", 
            "IBAN", 
            "IFSC Code", 
            "Insurance Policy No", 
            "Investment Account No", 
            "IP Address", 
            "Issue Date", 
            "Landline Number", 
            "Lease/Rental Agreement ID", 
            "Library Card", 
            "License Key", 
            "Loan Account No", 
            "Locker Combination", 
            "Loyalty Card Number", 
            "Membership No", 
            "Mobile No", 
            "Network Name", 
            "Notes", 
            "Ornament Details", 
            "Order Number", 
            "PAN", 
            "Passport No", 
            "Phone Number (Secondary)", 
            "PIN", 
            "P.O. Box", 
            "Port Number", 
            "Post Office Account No", 
            "Primary Phone", 
            "Project Code", 
            "Property Tax ID", 
            "Recovery Code", 
            "Recovery Email", 
            "Reference ID", 
            "Reg No", 
            "Router Password", 
            "Security Q&A", 
            "Security Token", 
            "Secret Key", 
            "Server Key", 
            "Shipping Tracking No", 
            "Silver Weight/Details", 
            "Software License", 
            "Software Version", 
            "Sponsor Code", 
            "SSH Key", 
            "Subscription ID", 
            "Swift Code", 
            "Tax Filing PIN", 
            "Tax ID", 
            "Trading PIN", 
            "Two-Factor Code", 
            "UPI ID", 
            "User ID", 
            "VC No", 
            "Virtual Machine Name", 
            "Voter ID", 
            "VPN Credentials", 
            "Water Bill Acc No", 
            "Website URL", 
            "WiFi Password"
        ];
        const MAX_CUSTOM_FIELDS = 5;

        // --- Utility Functions ---

        async function getKey(uid) {
            const enc = new TextEncoder();
            const base = await crypto.subtle.digest("SHA-256", enc.encode(uid + "_secret_key"));
            return crypto.subtle.importKey("raw", base, { name: "AES-GCM" }, false, ["encrypt","decrypt"]);
        }

        async function encryptString(text, uid) {
            const key = await getKey(uid);
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const enc = new TextEncoder().encode(text);
            const buf = await crypto.subtle.encrypt({ name: "AES-GCM", iv }, key, enc);
            return btoa(String.fromCharCode(...iv) + String.fromCharCode(...new Uint8Array(buf)));
        }

        async function decryptString(base64, uid) {
            try {
                const raw = atob(base64);
                const iv = Uint8Array.from(raw.slice(0,12), c=>c.charCodeAt(0));
                const data = Uint8Array.from(raw.slice(12), c=>c.charCodeAt(0));
                const key = await getKey(uid);
                const dec = await crypto.subtle.decrypt({ name:"AES-GCM", iv }, key, data);
                return new TextDecoder().decode(dec);
            } catch {
                return ""; // fallback if corrupted/plaintext
            }
        }

        function copyToClipboard(text, button) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = "Copy";
                const newText = "Copied!";
                button.innerText = newText;
                button.disabled = true;
                button.classList.remove("bg-blue-600");
                button.classList.add("bg-green-600");
                button.style.transform = "scale(1.1)";
                button.style.transition = "all 0.2s ease-in-out";
                setTimeout(() => {
                    button.innerText = originalText;
                    button.disabled = false;
                    button.classList.remove("bg-green-600");
                    button.classList.add("bg-blue-600");
                    button.style.transform = "scale(1)";
                }, 1500);
            });
        }

        function toggleVisibility(button) {
            const parent = button.closest("p");
            if (!parent) return;
            const valueSpan = parent.querySelector(".cred-value");
            const isHidden = valueSpan.textContent === "â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢";
            if (isHidden) {
                valueSpan.textContent = valueSpan.getAttribute("data-original");
                button.innerHTML = `<i class="fas fa-eye"></i>`;
                button.classList.remove("text-gray-500");
                button.classList.add("text-blue-600");
            } else {
                valueSpan.textContent = "â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢";
                button.innerHTML = `<i class="fas fa-eye-slash"></i>`;
                button.classList.remove("text-blue-600");
                button.classList.add("text-gray-500");
            }
        }

        // --- Custom Field Logic ---

        function updateAddButtonState(isMobile) {
            const container = document.getElementById(isMobile ? "custom-fields-container-m" : "custom-fields-container");
            const button = document.getElementById(isMobile ? "add-custom-field-btn-m" : "add-custom-field-btn");

            if (!container || !button) return;

            const currentFields = container.querySelectorAll(".custom-field-row").length;
            const primaryColor = isMobile ? "blue-700" : "blue-900";

            if (currentFields < MAX_CUSTOM_FIELDS) {
                button.disabled = false;
                button.innerText = `Add Custom Field (${MAX_CUSTOM_FIELDS - currentFields} max remaining)`;
                button.classList.remove("border-gray-400", "text-gray-400");
                button.classList.add(`border-${primaryColor}`, `text-${primaryColor}`, "hover:bg-blue-100");
            } else {
                button.disabled = true;
                button.innerText = "Maximum fields reached (5)";
                button.classList.remove("border-blue-700", "text-blue-700", "border-blue-900", "text-blue-900", "hover:bg-blue-100");
                button.classList.add("border-gray-400", "text-gray-400");
            }
        }

        function removeCustomField(button, isMobile) {
            const row = button.closest(".custom-field-row");
            if (row) {
                row.remove();
                updateAddButtonState(isMobile);
            }
        }
/**
 * Adds a custom field row to the container form.
 * FIX: Using py-2 for consistent height across all custom inputs/select.
 */
function addCustomField(isMobile=false, label = "", value = "") {
    const container = document.getElementById(isMobile ? "custom-fields-container-m" : "custom-fields-container");
    if (!container) return;

    const currentFields = container.querySelectorAll(".custom-field-row").length;
    if (currentFields >= MAX_CUSTOM_FIELDS) {
        updateAddButtonState(isMobile);
        return;
    }
    
    const id = Date.now() + Math.random().toString(36).substring(7);
    const isCustomLabel = label && !CUSTOM_FIELD_OPTIONS.includes(label);
    const selectedLabel = isCustomLabel ? 'Custom Label' : label;
    const customLabelValue = isCustomLabel ? label : '';
    
    // Determine the value placeholder text
    let valuePlaceholder = "Value (Optional)";
    if (value) {
        // If a value exists, we are likely editing. Show the label in the placeholder for clarity.
        valuePlaceholder = `Value (Label: ${label})`; 
    }
    
    // MODIFIED HEIGHT: py-2 for alignment/reduced height
    const selectClasses = "border px-3 py-2 rounded text-sm w-full focus:ring-2 focus:ring-blue-500";
    const inputClasses = "border px-3 py-2 rounded text-sm w-full focus:ring-2 focus:ring-blue-500";
    const removeBtnClasses = "text-red-500 hover:text-red-700 text-lg ml-2";

    const fieldRow = document.createElement('div');
    fieldRow.className = "custom-field-row flex items-center gap-1 mb-[2px]"; 
    fieldRow.innerHTML = `
        <div class="select-group">
            <select id="custom-label-select-${id}" class="${selectClasses} ${isCustomLabel ? 'hidden' : ''}">
                <option value="">-- Select Label --</option>
                ${CUSTOM_FIELD_OPTIONS.map(opt => `<option value="${opt}" ${opt === selectedLabel ? 'selected' : ''}>${opt}</option>`).join('')}
                </select>
            <input id="custom-label-text-input-${id}" 
                   class="${inputClasses} swapped-input ${isCustomLabel ? '' : 'hidden'}" 
                   placeholder="Enter Custom Label Name" 
                   value="${customLabelValue.replace(/"/g, '&quot;')}"
            />
        </div>
        
        <div class="input-group">
            <input id="custom-value-input-${id}" 
                   class="${inputClasses} w-full" 
                   placeholder="${valuePlaceholder}"  
                   value="${value.replace(/"/g, '&quot;')}"
            />
            <button type="button" onclick="removeCustomField(this, ${isMobile})" class="${removeBtnClasses}"><i class="fas fa-times"></i></button>
        </div>
    `;
    
    const selectElement = fieldRow.querySelector(`#custom-label-select-${id}`);
    const textInputElement = fieldRow.querySelector(`#custom-label-text-input-${id}`);
    
    // Simplified logic: If a custom label was loaded, the select is hidden and the text input is shown.
    if (selectElement) {
         selectElement.addEventListener('change', (e) => {
            // No swap needed since 'Other' is removed.
        });
    }

    container.appendChild(fieldRow);
    updateAddButtonState(isMobile);
}
    
        // --- Clear Form Function (Resetting placeholders) ---
        function clearForm(isMobile) {
            const suffix = isMobile ? "-m" : "";
            
            // Reset inputs and ID
            document.getElementById(`title${suffix}`).value = "";
            document.getElementById(`email${suffix}`).value = "";
            document.getElementById(`username${suffix}`).value = "";
            document.getElementById(`password${suffix}`).value = "";
            document.getElementById(`credential-id${isMobile ? '-mobile' : '-desktop'}`).value = "";
            document.getElementById(isMobile ? "custom-fields-container-m" : "custom-fields-container").innerHTML = "";

            // Reset placeholders to original text
            document.getElementById(`title${suffix}`).placeholder = "App / Web / Service / Product Name (Optional)";
            document.getElementById(`email${suffix}`).placeholder = "Email (Optional)";
            document.getElementById(`username${suffix}`).placeholder = "Username (Optional)";
            document.getElementById(`password${suffix}`).placeholder = "Password (Optional)";
            
            // Reset UI for 'Add New'
            document.getElementById(`form-title${suffix}`).innerText = "Add New Credential";
            document.getElementById(`save-btn${suffix}`).innerText = "Save Credential";
            document.getElementById(`cancel-edit-btn${suffix}`).classList.add("hidden");
            updateAddButtonState(isMobile);
        }

        // --- Save/Update Function ---
        async function saveOrUpdateCredential(isMobile=false) {
            const suffix = isMobile ? "-m" : "";
            const credentialIdEl = document.getElementById(`credential-id${isMobile ? '-mobile' : '-desktop'}`);
            const existingId = credentialIdEl.value;

            const title = document.getElementById(`title${suffix}`)?.value.trim();
            const email = document.getElementById(`email${suffix}`)?.value.trim();
            const username = document.getElementById(`username${suffix}`)?.value.trim();
            const password = document.getElementById(`password${suffix}`)?.value.trim();

            const payload = {
                // Use a default title if none is provided, or store the empty string
                title: title || "Untitled Credential",
                email: email?await encryptString(email,currentUser.uid):"",
                username: username?await encryptString(username,currentUser.uid):"",
                // Password is only encrypted if a non-empty value is provided
                password: password?await encryptString(password,currentUser.uid):"", 
                customFields: {}
            };

            // Get Custom Fields
            const containerId = isMobile ? "custom-fields-container-m" : "custom-fields-container";
            const customFieldsContainer = document.getElementById(containerId);
            const fieldRows = customFieldsContainer.querySelectorAll(".custom-field-row");

            for(const row of fieldRows) {
                const valueInput = row.querySelector('input[id^="custom-value-input-"]');
                const labelSelect = row.querySelector('select[id^="custom-label-select-"]');
                const labelTextInput = row.querySelector('input[id^="custom-label-text-input-"]');

                let actualValue = valueInput?.value.trim() || "";
                let label = labelSelect?.value.trim() || "";
                
                // Determine final label
                if (labelSelect.classList.contains('hidden') && labelTextInput) {
                    // Use the custom label text input value if it was visible (i.e., custom label loaded)
                    label = labelTextInput.value.trim() || "";
                } else if (!label) {
                    // If label is empty and select is visible, treat as skipped or invalid.
                    continue; 
                }
                
                // Only save custom fields if both a non-empty label and a non-empty value exist
                if (label && actualValue) {
                    payload.customFields[label] = await encryptString(actualValue, currentUser.uid);
                }
            }

            const id = existingId || Date.now().toString();
            db.ref(`users/${currentUser.uid}/credentials/${id}`).set(payload)
                .then(() => {
                    clearForm(isMobile);
                    
                    const action = existingId ? "Updated" : "Saved";
                    const saveMsg = document.getElementById(isMobile ? "save-message-m" : "save-message");
                    if(saveMsg) {
                        saveMsg.innerText = `Credential ${action}!`;
                        saveMsg.classList.remove("hidden");
                        setTimeout(() => saveMsg.classList.add("hidden"), 3000);
                    }
                    
                    // NEW FIX: Re-apply the filter after Firebase reload completes
                    filterPasswords(); 
                })
                .catch(error => {
                    alert("Error saving credential: " + error.message);
                });
        }

        // --- Edit Functionality (Pre-fill inputs and update placeholders) ---
        function editCredential(id, encoded) {
            const data = JSON.parse(decodeURIComponent(encoded));
            const isMobile = window.innerWidth < 768;
            const suffix = isMobile ? "-m" : "";

            clearForm(isMobile); // Clear existing form data first
            
            document.getElementById(`credential-id${isMobile ? '-mobile' : '-desktop'}`).value = id;
            
            // Get Elements
            const titleEl = document.getElementById(`title${suffix}`);
            const emailEl = document.getElementById(`email${suffix}`);
            const usernameEl = document.getElementById(`username${suffix}`);
            const passwordEl = document.getElementById(`password${suffix}`);

            // Set input values to current data
            titleEl.value = data.title || "";
            emailEl.value = data.email || "";
            usernameEl.value = data.username || "";
            passwordEl.value = data.password || "";

            // --- Update placeholders to show the context (Current Value) ---
            const currentTitle = data.title || "(Empty)";
            const currentEmail = data.email || "(Empty)";
            const currentUsername = data.username || "(Empty)";
            
            // For password, show a generic indicator since the actual value is sensitive
            const currentPasswordDisplay = data.password ? "******" : "(Empty)";

            // Setting placeholders with the label AND the current value
            const newTitlePlaceholder = `App / Web / Service / Product Name (Current: ${currentTitle})`;
            const newEmailPlaceholder = `Email (Current: ${currentEmail})`;
            const newUsernamePlaceholder = `Username (Current: ${currentUsername})`;
            const newPasswordPlaceholder = `Password (Current: ${currentPasswordDisplay} - Enter new)`;
            
            titleEl.placeholder = newTitlePlaceholder;
            emailEl.placeholder = newEmailPlaceholder;
            usernameEl.placeholder = newUsernamePlaceholder;
            passwordEl.placeholder = newPasswordPlaceholder;


            if (data.customFields) {
                Object.entries(data.customFields).forEach(([label, value]) => {
                    // addCustomField handles the custom field value/label setting
                    addCustomField(isMobile, label, value);
                });
            }

            // Update Form UI
            document.getElementById(`form-title${suffix}`).innerText = `Editing: ${currentTitle}`;
            document.getElementById(`save-btn${suffix}`).innerText = "Update Credential";
            document.getElementById(`cancel-edit-btn${suffix}`).classList.remove("hidden");
            
            titleEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        function cancelEdit(isMobile) {
            clearForm(isMobile);
            const saveMsg = document.getElementById(isMobile ? "save-message-m" : "save-message");
            if(saveMsg) saveMsg.innerText = "Credential saved!";
        }

        // --- Load Credentials (Decryption and Display) ---
        async function loadCredentials() {
            const desktopList = document.getElementById("cred-list");
            const mobileList = document.getElementById("cred-list-mobile");
            const mobileOverlayList = document.getElementById("cred-list-mobile-overlay"); 
            
            desktopList.innerHTML=`<p class="text-gray-500">Loading...</p>`;
            mobileList.innerHTML=`<p class="text-gray-500">Loading...</p>`;
            mobileOverlayList.innerHTML = ''; 

            db.ref(`users/${currentUser.uid}/credentials`).on("value", async snapshot=>{
                desktopList.innerHTML="";
                mobileList.innerHTML="";
                mobileOverlayList.innerHTML=""; 

                const rawCredentials = snapshot.val();
                if(!rawCredentials){
                    const msg=`<p class="text-gray-500">No credentials found.</p>`;
                    desktopList.innerHTML=msg;
                    mobileList.innerHTML=msg;
                    mobileOverlayList.innerHTML=msg;
                    return;
                }

                for(const [id,data] of Object.entries(rawCredentials)){
                    const decEmail = data.email?await decryptString(data.email,currentUser.uid):"";
                    const decUsername = data.username?await decryptString(data.username,currentUser.uid):"";
                    const decPassword = data.password?await decryptString(data.password,currentUser.uid):"";
                    
                    const decryptedData = {title:data.title,email:decEmail,username:decUsername,password:decPassword, customFields: {}};
                    
                    let customHtml = "";
                    if (data.customFields) {
                        for(const [label, encryptedValue] of Object.entries(data.customFields)) {
                            const decryptedValue = await decryptString(encryptedValue, currentUser.uid);
                            decryptedData.customFields[label] = decryptedValue;
                            if (decryptedValue) {
                                customHtml += `
                                <p class="text-sm text-gray-600 flex items-center justify-between mb-1">
                                    <span>${label}: <span class="cred-value" data-original="${decryptedValue}">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</span></span>
                                    <span class="flex items-center gap-1">
                                        <button onclick="toggleVisibility(this)" class="text-gray-500 hover:text-gray-900 text-sm"><i class="fas fa-eye-slash"></i></button>
                                        <button onclick="copyToClipboard('${decryptedValue.replace(/'/g, "\\'")}', this)" class="px-2 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700">Copy</button>
                                    </span>
                                </p>`;
                            }
                        }
                    }

                    const safeData=encodeURIComponent(JSON.stringify(decryptedData));

                    const html = `
                    <div class="password-item border p-4 rounded shadow bg-gray-50 flex flex-col" data-id="${id}">
                        <h3 class="website-name font-semibold text-lg text-black mb-2">${data.title || "Untitled Credential"}</h3>
                        ${decEmail?`<p class="text-sm text-gray-600 flex items-center justify-between mb-1">
                            <span>Email: <span class="cred-value" data-original="${decEmail}">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</span></span>
                            <span class="flex items-center gap-1">
                                <button onclick="toggleVisibility(this)" class="text-gray-500 hover:text-gray-900 text-sm"><i class="fas fa-eye-slash"></i></button>
                                <button onclick="copyToClipboard('${decEmail.replace(/'/g, "\\'")}', this)" class="px-2 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700">Copy</button>
                            </span>
                        </p>`:""}
                        ${decUsername?`<p class="text-sm text-gray-600 flex items-center justify-between mb-1">
                            <span>Username: <span class="cred-value" data-original="${decUsername}">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</span></span>
                            <span class="flex items-center gap-1">
                                <button onclick="toggleVisibility(this)" class="text-gray-500 hover:text-gray-900 text-sm"><i class="fas fa-eye-slash"></i></button>
                                <button onclick="copyToClipboard('${decUsername.replace(/'/g, "\\'")}', this)" class="px-2 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700">Copy</button>
                            </span>
                        </p>`:""}
                        ${decPassword?`<p class="text-sm text-gray-600 flex items-center justify-between mb-1">
                            <span>Password: <span class="cred-value" data-original="${decPassword}">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</span></span>
                            <span class="flex items-center gap-1">
                                <button onclick="toggleVisibility(this)" class="text-gray-500 hover:text-gray-900 text-sm"><i class="fas fa-eye-slash"></i></button>
                                <button onclick="copyToClipboard('${decPassword.replace(/'/g, "\\'")}', this)" class="px-2 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700">Copy</button>
                            </span>
                        </p>`:""}
                        ${customHtml}
                        <div class="mt-3 flex gap-3 justify-start">
                            <button onclick="editCredential('${id}', '${safeData}')" class="text-blue-600 hover:underline"><i class="fas fa-edit mr-1"></i>Edit</button>
                            <button onclick="deleteCredential('${id}')" class="text-red-600 hover:underline"><i class="fas fa-trash mr-1"></i>Delete</button>
                            <button onclick="shareCredential('${safeData}')" class="text-green-600 hover:underline"><i class="fas fa-share-alt mr-1"></i>Share</button>
                        </div>
                    </div>`;
                    if(desktopList) desktopList.innerHTML+=html;
                    mobileList.innerHTML+=html; // Put results in normal view
                    mobileOverlayList.innerHTML+=html; // Put results in overlay view
                }
            });
        }
        
        // --- Search/Filter Logic ---
        function filterPasswords(){
            // Determine which search field to use to get the query:
            const desktopQuery = document.getElementById("searchInput")?.value.toLowerCase() || "";
            const mobileOverlayQuery = document.getElementById("searchInputMobileOverlay")?.value.toLowerCase() || "";
            
            // Get the active query based on screen size/overlay state
            const q = window.innerWidth < 768 ? mobileOverlayQuery : desktopQuery;
            
            // Get all possible list containers (desktop, mobile standard list, mobile overlay list)
            const lists = [
                document.getElementById("cred-list"),
                document.getElementById("cred-list-mobile"),
                document.getElementById("cred-list-mobile-overlay")
            ].filter(list => list !== null);

            lists.forEach(list => {
                list.querySelectorAll(`.password-item`).forEach(item => {
                    const itemText = item.textContent.toLowerCase();
                    // Show item only if the current active query matches, OR if the query is empty.
                    item.style.display = itemText.includes(q) ? "flex" : "none";
                });
            });
        }

        // --- Full-Screen Mobile Search Logic ---

        function openMobileSearch() {
            const overlay = document.getElementById('mobile-search-overlay');
            const mainSearchInput = document.getElementById('searchInputMobile');
            const overlaySearchInput = document.getElementById('searchInputMobileOverlay');
            
            overlay.style.display = 'block';
            
            // Sync initial value and focus
            overlaySearchInput.value = mainSearchInput.value;
            overlaySearchInput.focus();
            
            // Re-run filter on the overlay results container
            filterPasswords(); 
        }

        function closeMobileSearch() {
            const overlay = document.getElementById('mobile-search-overlay');
            const mainSearchInput = document.getElementById('searchInputMobile');
            const overlaySearchInput = document.getElementById('searchInputMobileOverlay');
            
            // Sync value back to main search input and clear overlay input
            mainSearchInput.value = overlaySearchInput.value;
            // The search should persist in the main input, so we don't clear the overlay input here.
            // We just hide the overlay.
            
            overlay.style.display = 'none';
        }

        // --- Logout Handler ---
        function handleLogout() {
            auth.signOut().then(() => {
                // Redirection is handled by auth.onAuthStateChanged
            });
        }


        // --- Event Listeners and Auth ---

        document.getElementById("save-btn")?.addEventListener("click",()=>saveOrUpdateCredential(false));
        document.getElementById("save-btn-m")?.addEventListener("click",()=>saveOrUpdateCredential(true));
        
        document.getElementById("cancel-edit-btn")?.addEventListener("click",()=>cancelEdit(false));
        document.getElementById("cancel-edit-btn-m")?.addEventListener("click",()=>cancelEdit(true));
        
        document.getElementById("add-custom-field-btn")?.addEventListener("click", () => addCustomField(false));
        document.getElementById("add-custom-field-btn-m")?.addEventListener("click", () => addCustomField(true));

        // When the user types into the desktop search box, filter immediately
        document.getElementById("searchInput")?.addEventListener("input", filterPasswords);
        
        // When the user clicks on the mobile input, open the overlay
        document.getElementById("searchInputMobile")?.addEventListener("click", openMobileSearch); 
        // When the user closes the overlay, close it
        document.getElementById("close-search-btn")?.addEventListener("click", closeMobileSearch); 
        
        // When the user types in the mobile overlay search box, filter immediately
        document.getElementById("searchInputMobileOverlay")?.addEventListener("input", filterPasswords); 


        // Mobile Menu Toggle
        document.getElementById("menu-btn")?.addEventListener("click", () => {
            document.getElementById("mobile-menu").classList.toggle("hidden");
            document.getElementById("menu-btn").querySelector('i').classList.toggle("fa-bars");
            document.getElementById("menu-btn").querySelector('i').classList.toggle("fa-times");
        });

        // Auth listener
        auth.onAuthStateChanged(user=>{
            if(user){
                currentUser=user;
                // Desktop profile
                document.getElementById("user-name").innerText=user.displayName||"User";
                document.getElementById("user-email").innerText=user.email||"";
                document.getElementById("user-pic").src=user.photoURL||"https://via.placeholder.com/40";
                
                // Load decrypted credentials
                loadCredentials();
            } else {
                // Redirect if not logged in
                location.href="index.html"; 
            }
        });

        // Logout buttons (Using unified handler)
        document.getElementById("logout-btn")?.addEventListener("click", handleLogout);
        document.getElementById("mobileLogout")?.addEventListener("click", handleLogout);

        // --- Other CRUD & Share Functions (Included for completeness) ---

        function deleteCredential(id){
            if(confirm("Are you sure you want to delete this credential?")){
                db.ref(`users/${currentUser.uid}/credentials/${id}`).remove();
            }
        }

        function shareCredential(encoded){
            const data=JSON.parse(decodeURIComponent(encoded));
            let text=`Website/App: ${data.title}\n`;
            if(data.email) text+=`Email: ${data.email}\n`;
            if(data.username) text+=`Username: ${data.username}\n`;
            if(data.password) text+=`Password: ${data.password}\n`;
            
            if (data.customFields && Object.keys(data.customFields).length > 0) {
                text += "\n--- Custom Fields ---\n";
                Object.entries(data.customFields).forEach(([label, value]) => {
                    text += `${label}: ${value}\n`;
                });
            }

            if(navigator.share){
                navigator.share({title:`Credential for ${data.title}`, text}).catch(()=>alert("Sharing failed or was cancelled."));
            } else alert("Web Share API is not supported on this browser. You can manually copy the content:\n\n" + text);
        }
    </script>
</body>
</html>











































