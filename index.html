<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Login | Two-Factor Authentication</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        .card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .msg-box {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            display: none;
            align-items: center;
            z-index: 1000;
        }
        .msg-box.show {
            opacity: 1;
        }
        .msg-box.success {
            background-color: #10B981; /* Tailwind green-500 */
        }
        .msg-box.error {
            background-color: #EF4444; /* Tailwind red-500 */
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">

    <div id="msgBox" class="msg-box"></div>

    <div class="w-full max-w-md">

        <div id="loginCard" class="card bg-white p-8 rounded-lg shadow-lg">
            <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Sign In to Your Account</h2>
            <button id="googleLoginBtn" class="w-full flex items-center justify-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-150">
                <i class="fab fa-google mr-2"></i> Sign in with Google
            </button>
        </div>

        <div id="pinCard" class="card bg-white p-8 rounded-lg shadow-lg hidden">
            <h2 id="pinTitle" class="text-2xl font-bold mb-6 text-center text-gray-800">Enter Your PIN</h2>
            
            <div id="standardPinInput" class="mb-4">
                <input id="pinInput" type="password" maxlength="6" class="shadow appearance-none border rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline text-center text-xl tracking-widest" placeholder="• • • • • •">
            </div>

            <div id="resetPinInputs" class="hidden flex-col gap-3 mb-4">
                <input id="currentPinInput" type="password" maxlength="6" class="shadow appearance-none border rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline text-center tracking-widest" placeholder="Current PIN">
                <input id="newPinInput" type="password" maxlength="6" class="shadow appearance-none border rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline text-center tracking-widest" placeholder="New PIN (4-6 digits)">
                <input id="confirmNewPinInput" type="password" maxlength="6" class="shadow appearance-none border rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline text-center tracking-widest" placeholder="Confirm New PIN">
            </div>
            
            <button id="pinActionBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-150 mb-3">
                Verify PIN
            </button>

            <div class="flex justify-between text-sm mt-4">
                <button id="forgotPinBtn" class="text-gray-500 hover:text-gray-700 hidden">Forgot PIN?</button>
                <button id="resetPinBtn" class="text-gray-500 hover:text-gray-700 hidden">Change PIN</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3.2.0/dist/email.min.js"></script>

    <script>
        // Initialize EmailJS (Replace with your actual User ID)
        emailjs.init("YOUR_EMAILJS_USER_ID"); 

        // ----------------------------------------------------------------------
        // 1. CONFIGURATION & INITIALIZATION
        // ----------------------------------------------------------------------
        const firebaseConfig = {
            // REPLACE THESE WITH YOUR ACTUAL FIREBASE CONFIGURATION
            apiKey: "AIzaSyB78RTVCg0cmSPp7A1RJyyAgBuCeolO0cc", 
            authDomain: "sk12-58e9e.firebaseapp.com",
            projectId: "sk12-58e9e",
            storageBucket: "sk12-58e9e.appspot.com",
            messagingSenderId: "470207874652",
            appId: "1:470207874652:web:67ba1cf3629b7e5b144899"
        };

        if (typeof firebase !== 'undefined' && firebase.apps.length === 0) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = typeof firebase !== 'undefined' ? firebase.auth() : null;
        const db = typeof firebase !== 'undefined' ? firebase.firestore() : null;
        const provider = typeof firebase !== 'undefined' ? new firebase.auth.GoogleAuthProvider() : null; 
        const MAX_ATTEMPTS = 5; 

        let currentUID = null, currentEmail = null, currentPIN = null;
        let isFirstTime = false;

        // Cache DOM Elements
        const msgBoxEl = document.getElementById("msgBox");
        const loginCardEl = document.getElementById("loginCard");
        const pinCardEl = document.getElementById("pinCard"); 
        const pinTitleEl = document.getElementById("pinTitle");
        const pinActionBtnEl = document.getElementById("pinActionBtn");
        const pinInputEl = document.getElementById("pinInput"); 
        const resetInputsEl = document.getElementById("resetPinInputs"); 
        const currentPinInputEl = document.getElementById("currentPinInput");
        const newPinInputEl = document.getElementById("newPinInput");
        const confirmNewPinInputEl = document.getElementById("confirmNewPinInput");
        const forgotPinBtnEl = document.getElementById("forgotPinBtn"); 
        const resetPinBtnEl = document.getElementById("resetPinBtn");
        const googleLoginBtn = document.getElementById("googleLoginBtn");

        // ----------------------------------------------------------------------
        // 2. HELPER FUNCTIONS
        // ----------------------------------------------------------------------
        async function hashPIN(pin) {
            if (!crypto.subtle) return pin; 
            try {
                const buf = new TextEncoder().encode(pin);
                const hashBuf = await crypto.subtle.digest('SHA-256', buf);
                const hashArray = new Uint8Array(hashBuf);
                // Convert buffer to hex string
                return Array.from(hashArray, b => b.toString(16).padStart(2, '0')).join('');
            } catch (e) {
                console.error("PIN hashing failed:", e);
                return pin; 
            }
        }

        function showMsg(msg, success = true) {
            const iconClass = success ? 'fas fa-check-circle' : 'fas fa-times-circle';
            msgBoxEl.innerHTML = `<i class="${iconClass} mr-2"></i><span>${msg}</span>`;
            msgBoxEl.classList.remove('success', 'error', 'show');
            msgBoxEl.classList.add(success ? 'success' : 'error');
            msgBoxEl.style.display = "flex";

            requestAnimationFrame(() => {
                msgBoxEl.classList.add('show');
            });

            setTimeout(() => {
                msgBoxEl.classList.remove('show');
                setTimeout(() => msgBoxEl.style.display = "none", 300); 
            }, 8000); 
        }

        function sendEmailPin(pin, email) {
            if (typeof emailjs === 'undefined' || !emailjs.send) {
                console.error("EmailJS SDK is not loaded or initialized.");
                showMsg("Warning: Email service unavailable. PIN reset, but recovery email not sent.", false);
                return;
            }
            // Template ID and Service ID must be configured in EmailJS
            emailjs.send('service_2ucolxw', 'template_2lc2llr', { user_email: email, user_pin: pin })
                .then(() => console.log("✅ PIN email sent"))
                .catch(e => console.error("❌ Email error", e));
        }

        async function getLock() {
            if (!db || !currentUID) return { attempts: 0, lockUntil: 0 };
            try {
                const doc = await db.collection("users").doc(currentUID).get();
                if (!doc.exists) return { attempts: 0, lockUntil: 0 };
                const d = doc.data();
                // Convert Firestore Timestamp to milliseconds for comparison
                return { attempts: d.attempts || 0, lockUntil: d.lockUntil?.toMillis() || 0 };
            } catch (e) {
                console.error("Error fetching lock status from Firestore:", e);
                showMsg("A critical database error occurred. Cannot proceed.", false);
                throw new Error("Firestore read failed."); 
            }
        }

        function updateLock(attempts, lockUntil = null) {
            if (!db || !currentUID) return;
            const upd = { attempts };
            // Use Firebase Timestamp for lockUntil in Firestore
            if (lockUntil) upd.lockUntil = firebase.firestore.Timestamp.fromMillis(lockUntil);
            else if (attempts === 0) upd.lockUntil = firebase.firestore.FieldValue.delete();
            
            db.collection("users").doc(currentUID).update(upd).catch(e => console.error("Failed to update lock status:", e)); 
        }


        // ----------------------------------------------------------------------
        // 3. CORE LOGIC - HANDLE LOGIN & PIN CARD DISPLAY
        // ----------------------------------------------------------------------

        /**
         * Central function to handle successful Google login and check PIN status.
         */
        async function handleUserLogin(user) {
            if (!db) {
                showMsg("Database connection failed. Cannot proceed.", false);
                loginCardEl.classList.remove("hidden");
                return;
            }

            currentUID = user.uid;
            currentEmail = user.email;

            // Step 1: Hide login card and reset pin card view
            loginCardEl.classList.add("hidden");
            pinCardEl.classList.add("hidden"); 
            pinInputEl.value = ""; 
            resetInputsEl.classList.add("hidden"); // Ensure reset view is hidden

            try {
                const doc = await db.collection("users").doc(currentUID).get();

                if (!doc.exists) {
                    // First time user: Set PIN
                    isFirstTime = true;
                    pinTitleEl.textContent = "Set Your PIN";
                    pinActionBtnEl.textContent = "Set PIN";
                    forgotPinBtnEl.classList.add("hidden"); 
                    resetPinBtnEl.classList.add("hidden"); 
                    pinInputEl.classList.remove("hidden");
                } else {
                    // Returning user: Verify PIN
                    const data = doc.data();
                    currentPIN = data.pin;
                    isFirstTime = false;
                    pinTitleEl.textContent = "Enter Your PIN";
                    pinActionBtnEl.textContent = "Verify PIN";
                    forgotPinBtnEl.classList.remove("hidden");
                    resetPinBtnEl.classList.remove("hidden");
                    pinInputEl.classList.remove("hidden"); 

                    // Check for account lock status
                    const { attempts, lockUntil } = await getLock();
                    const now = Date.now();
                    if (lockUntil && now < lockUntil) {
                        const mins = Math.ceil((lockUntil - now) / (60 * 1000));
                        showMsg(`⛔ Account Locked: Too many failed attempts. Please wait ${mins} minute(s).`, false);
                        pinActionBtnEl.disabled = true;
                        pinInputEl.disabled = true;
                    } else {
                        // Reset lock/disable state if lock time has passed
                        if (lockUntil && now >= lockUntil) updateLock(0); 
                        pinActionBtnEl.disabled = false;
                        pinInputEl.disabled = false;
                    }
                }
                
                // Step 2: SHOW THE PIN CARD 
                pinCardEl.classList.remove("hidden");
                pinInputEl.focus(); 

            } catch (e) {
                console.error("Firestore user data fetch failed:", e);
                showMsg("Login process interrupted due to a database error.", false);
                loginCardEl.classList.remove("hidden");
                pinCardEl.classList.add("hidden");
            }
        }

        // ----------------------------------------------------------------------
        // 4. EVENT LISTENERS
        // ----------------------------------------------------------------------

        // Google Sign-In button click
        googleLoginBtn.onclick = async () => {
            if (!auth || !db || !provider) {
                 showMsg("Initialization Error: Services not loaded.", false);
                 return;
            }
            try {
                showMsg("Redirecting to Google for sign-in...", true);
                await auth.signInWithRedirect(provider);
            } catch (e) {
                showMsg("Login initiation failed: " + e.message, false);
            }
        };


        // PIN Action (Set PIN, Verify PIN, Update PIN)
        pinActionBtnEl.onclick = async () => {
            const pinInput = pinInputEl.value;
            
            // --- A. PIN Reset/Change Logic ---
            if (!resetInputsEl.classList.contains("hidden")) {
                const cur = currentPinInputEl.value;
                const newPin = newPinInputEl.value;
                const conf = confirmNewPinInputEl.value;

                if (!cur || !newPin || !conf) return showMsg("Please complete all fields to reset your PIN.", false);
                if (newPin.length < 4 || newPin.length > 6 || isNaN(newPin)) return showMsg("The new PIN must be 4 to 6 digits.", false);
                if (newPin !== conf) return showMsg("New PIN and Confirm New PIN do not match.", false);

                const hashedCur = await hashPIN(cur);
                if (hashedCur !== currentPIN) return showMsg("The Current PIN you entered is incorrect.", false);

                const hashedNew = await hashPIN(newPin);
                currentPIN = hashedNew;
                
                db.collection("users").doc(currentUID).update({ pin: hashedNew, attempts: 0, lockUntil: firebase.firestore.FieldValue.delete() })
                    .then(() => {
                        showMsg("✅ Success! Your PIN has been updated. Redirecting...", true);
                        setTimeout(() => window.location.href = "home.html", 1000);
                    })
                    .catch(() => showMsg("An error occurred while saving the new PIN. Please try again.", false));
                return;
            }


            // --- B. Initial PIN Set Logic (First-time user) ---
            if (isFirstTime) {
                if (pinInput.length < 4 || pinInput.length > 6 || isNaN(pinInput)) return showMsg("The PIN must be 4 to 6 digits.", false);

                const hashed = await hashPIN(pinInput);
                currentPIN = hashed;
                
                db.collection("users").doc(currentUID).set({ pin: hashed, attempts: 0, email: currentEmail })
                    .then(() => {
                        showMsg("✅ Setup Complete! Redirecting to your dashboard...", true);
                        setTimeout(() => window.location.href = "home.html", 1000);
                    })
                    .catch(() => showMsg("An error occurred during initial PIN setup. Check Firestore rules.", false));
                return;
            }

            // --- C. PIN Verification Logic (Returning user) ---
            if (!pinInput) return showMsg("Please enter your PIN to proceed.", false);
            
            let attempts;
            let lockUntil;
            try { ({ attempts, lockUntil } = await getLock()); } catch (e) { return; }

            const now = Date.now();

            if (lockUntil && now < lockUntil) {
                const mins = Math.ceil((lockUntil - now) / (60 * 1000));
                showMsg(`⛔ Account Locked. Please wait ${mins} minute(s).`, false);
                return;
            }

            const hashed = await hashPIN(pinInput);

            if (hashed === currentPIN) {
                // SUCCESS
                showMsg("Login successful! Redirecting...", true);
                updateLock(0);
                setTimeout(() => {
                    window.location.href = "home.html"; // FINAL REDIRECT
                }, 1000);
            } else {
                // FAILURE
                let newAtt = attempts + 1;
                let newLock = null;
                let message;
                pinInputEl.value = ""; // Clear input on failure

                if (newAtt >= MAX_ATTEMPTS) { 
                    const lockDurationMs = 24 * 60 * 60 * 1000; 
                    newLock = now + lockDurationMs;
                    message = `⛔ Account Locked: ${MAX_ATTEMPTS} attempts failed. Restricted for 24 hours.`;
                    updateLock(newAtt, newLock);
                    pinActionBtnEl.disabled = true;
                    pinInputEl.disabled = true;
                } else {
                    const remaining = MAX_ATTEMPTS - newAtt;
                    message = `❌ Incorrect PIN. ${remaining} attempts remaining.`;
                    updateLock(newAtt);
                }
                showMsg(message, false);
            }
        };


        // Forgot PIN (Reset and Email)
        forgotPinBtnEl.onclick = async () => {
            if (!currentUID || !currentEmail) {
                return showMsg("Authentication state error. Please sign in again.", false);
            }

            showMsg("Attempting to reset PIN and send recovery email...", true);
            
            // Generate a new 6-digit random PIN
            const newPin = Math.floor(100000 + Math.random() * 900000).toString();
            const hashedNewPin = await hashPIN(newPin);

            try {
                // 1. Update Firestore with the new hashed PIN, reset lock status
                await db.collection("users").doc(currentUID).update({
                    pin: hashedNewPin,
                    attempts: 0,
                    lockUntil: firebase.firestore.FieldValue.delete()
                });

                // 2. Send the temporary unhashed PIN to the user's email
                sendEmailPin(newPin, currentEmail);

                // 3. Log out and refresh page
                showMsg("✅ Success! A temporary PIN has been sent to your email. Please log in again using the new PIN.", true);
                
                await auth.signOut();
                
                setTimeout(() => {
                    window.location.reload();
                }, 5000); 

            } catch (e) {
                console.error("Forgot PIN failed:", e);
                showMsg("An error occurred while resetting your PIN.", false);
            }
        };

        // Reset PIN (Show inputs)
        resetPinBtnEl.onclick = () => {
            pinTitleEl.textContent = "Change PIN";
            pinActionBtnEl.textContent = "Update PIN";
            pinInputEl.classList.add("hidden"); 
            resetInputsEl.classList.remove("hidden");
            resetInputsEl.classList.add("flex");
            forgotPinBtnEl.classList.add("hidden");
            resetPinBtnEl.classList.add("hidden");

            // Clear all inputs when showing
            currentPinInputEl.value = newPinInputEl.value = confirmNewPinInputEl.value = "";
        };


        // ----------------------------------------------------------------------
        // 5. INITIAL PAGE LOAD HANDLER (Handles redirect result)
        // ----------------------------------------------------------------------

        if (auth && provider) {
            // Check for a redirect result (This runs when returning from Google login)
            auth.getRedirectResult()
                .then((result) => {
                    if (result.user) {
                        // User successfully signed in via redirect. Proceed to PIN screen.
                        handleUserLogin(result.user);
                    } else {
                        // No redirect result, check for an existing signed-in user
                        auth.onAuthStateChanged((user) => {
                            if (user) {
                                // User is signed in from a previous session or after a refresh
                                handleUserLogin(user);
                            } else {
                                // No user, show the initial login card.
                                loginCardEl.classList.remove("hidden");
                                pinCardEl.classList.add("hidden");
                            }
                        });
                    }
                })
                .catch((error) => {
                    console.error("Google Auth Error:", error);
                    showMsg("Sign-in failed. Please try again: " + error.message, false);
                    loginCardEl.classList.remove("hidden");
                });
        } else {
            loginCardEl.classList.remove("hidden");
            showMsg("Critical Error: Authentication services not available.", false);
        }
    </script>
</body>
</html>

