<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>My Personal Website</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
body { font-family:'Segoe UI',sans-serif; background-color:#f8fafc; overflow-x:hidden; }
.animate-card { animation:fadeSlideUp 0.8s ease-out forwards; }
@keyframes fadeSlideUp {0%{opacity:0;transform:translateY(40px) scale(0.95);}100%{opacity:1;transform:translateY(0) scale(1);} }
.btn-hover { transition: all 0.3s ease; }
.btn-hover:hover { transform:scale(1.05) translateY(-3px); box-shadow:0 10px 20px rgba(0,0,0,0.2); background-color:#0d6efd; color:white; }
</style>
</head>
<body class="min-h-screen flex flex-col justify-between">

<nav class="bg-white shadow-md p-4">
  <div class="container mx-auto flex justify-between items-center">
    <div class="text-xl font-bold text-black flex items-center gap-2">
      <i class="fas fa-user-circle text-2xl text-blue-500"></i>
      <span class="text-xl font-bold">My Personal Website</span>
    </div>
  </div>
</nav>

<main class="flex-grow flex items-center justify-center bg-gray-100 px-4 w-full">

  <!-- Google Login -->
  <div id="loginCard" class="border-2 border-gray-200 rounded-2xl p-8 sm:p-10 shadow-xl bg-white w-full max-w-sm sm:max-w-md text-center animate-card">
    <h2 class="text-xl sm:text-2xl font-semibold mb-6 text-gray-700">Login with Google</h2>
    <button id="googleLoginBtn" class="flex items-center justify-center gap-3 text-lg sm:text-xl font-medium px-6 sm:px-8 py-3 sm:py-4 rounded-full bg-white text-gray-800 border-2 border-blue-500 shadow-md btn-hover mx-auto">
      <img src="https://developers.google.com/identity/images/g-logo.png" class="w-6 h-6 sm:w-7 sm:h-7"> Sign in with Google
    </button>
  </div>

  <!-- PIN Card -->
  <div id="pinCard" class="hidden border-2 border-gray-200 rounded-2xl p-8 sm:p-10 shadow-xl bg-white w-full max-w-sm sm:max-w-md text-center animate-card">

    <h2 id="pinTitle" class="text-xl sm:text-2xl font-semibold mb-6 text-gray-700">Enter PIN</h2>

    <!-- Standard PIN input -->
    <input id="pinInput" type="password" maxlength="6" placeholder="Enter 4-6 digit PIN" class="w-full p-3 border rounded-lg mb-4 text-center"/>

    <!-- Reset PIN inputs (hidden initially) -->
    <div id="resetPinInputs" class="hidden flex flex-col gap-3 mb-4">
      <input id="currentPinInput" type="password" maxlength="6" placeholder="Current PIN" class="w-full p-3 border rounded-lg text-center"/>
      <input id="newPinInput" type="password" maxlength="6" placeholder="New PIN" class="w-full p-3 border rounded-lg text-center"/>
      <input id="confirmNewPinInput" type="password" maxlength="6" placeholder="Confirm New PIN" class="w-full p-3 border rounded-lg text-center"/>
    </div>

    <button id="pinActionBtn" class="w-full py-3 rounded-lg bg-blue-500 text-white font-semibold btn-hover mb-2"></button>
    <p class="mt-2 text-sm text-blue-600 cursor-pointer hover:underline" id="forgotPinBtn">Forgot PIN?</p>
    <p class="mt-1 text-sm text-blue-600 cursor-pointer hover:underline" id="resetPinBtn">Reset PIN</p>

  </div>

</main>

<footer class="bg-white text-gray-700 text-center p-4 border-t text-sm sm:text-base">
  &copy; 2025 MyFinance Tracker | All Rights Reserved.
</footer>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>

<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3.2.0/dist/email.min.js"></script>
<script>
emailjs.init("NbamX634Y_o570cNw"); // Your EmailJS public key
</script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyB78RTVCg0cmSPp7A1RJyyAgBuCeolO0cc",
  authDomain: "sk12-58e9e.firebaseapp.com",
  projectId: "sk12-58e9e",
  storageBucket: "sk12-58e9e.appspot.com",
  messagingSenderId: "470207874652",
  appId: "1:470207874652:web:67ba1cf3629b7e5b144899"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const provider = new firebase.auth.GoogleAuthProvider();

let currentUID = null, currentEmail = null, currentPIN = null;
let isFirstTime = false;

// --- Google Login ---
document.getElementById("googleLoginBtn").onclick = async () => {
  try {
    const result = await auth.signInWithPopup(provider);
    currentUID = result.user.uid;
    currentEmail = result.user.email;

    const doc = await db.collection("users").doc(currentUID).get();
    document.getElementById("loginCard").classList.add("hidden");
    document.getElementById("pinCard").classList.remove("hidden");

    if (!doc.exists) {
      isFirstTime = true;
      document.getElementById("pinTitle").textContent = "Set Your PIN";
      document.getElementById("pinActionBtn").textContent = "Set PIN";
    } else {
      currentPIN = doc.data().pin;
      document.getElementById("pinTitle").textContent = "Enter PIN";
      document.getElementById("pinActionBtn").textContent = "Verify PIN";
    }

  } catch(e) { alert("Login failed: " + e.message); }
};

// --- PIN Action Button ---
document.getElementById("pinActionBtn").onclick = async () => {
  const resetInputs = document.getElementById("resetPinInputs");

  // --- Reset PIN mode ---
  if (!resetInputs.classList.contains("hidden")) {
    const currentPin = document.getElementById("currentPinInput").value;
    const newPin = document.getElementById("newPinInput").value;
    const confirmPin = document.getElementById("confirmNewPinInput").value;

    if (!currentPin || !newPin || !confirmPin) { alert("Fill all fields"); return; }
    if (currentPin !== currentPIN) { alert("❌ Current PIN is incorrect"); return; }
    if (newPin.length < 4) { alert("New PIN must be 4-6 digits"); return; }
    if (newPin !== confirmPin) { alert("❌ New PIN and Confirm PIN do not match"); return; }

    db.collection("users").doc(currentUID).update({pin: newPin}); // no await
    currentPIN = newPin;
    sendEmailPin(newPin, currentEmail);
    window.location.href = "home.html"; // redirect instantly
    return;
  }

  // --- First-time PIN setup ---
  if (isFirstTime) {
    const pin = document.getElementById("pinInput").value;
    if (!pin || pin.length < 4) { alert("Enter 4-6 digit PIN"); return; }
    db.collection("users").doc(currentUID).set({pin}); // no await
    currentPIN = pin;
    sendEmailPin(pin, currentEmail);
    window.location.href = "home.html"; // redirect instantly
    return;
  }

  // --- Normal PIN verification ---
  const pin = document.getElementById("pinInput").value;
  if (!pin || pin.length < 4) { alert("Enter 4-6 digit PIN"); return; }

  // check directly from cached currentPIN
  if (pin === currentPIN) {
    window.location.href = "home.html"; // redirect instantly
  } else {
    alert("❌ Wrong PIN");
  }
};

// --- Forgot PIN ---
// --- Forgot PIN ---
document.getElementById("forgotPinBtn").onclick = async () => {
  if (!currentEmail) { 
    alert("Login first!"); 
    return; 
  }

  // Generate random 4-digit PIN
  const newPin = Math.floor(1000 + Math.random() * 9000).toString();

  try {
    // Update Firestore (store hashed version for security)
    const hashedPin = await sha256(newPin); 
    await db.collection("users").doc(currentUID).update({pin: hashedPin});
    currentPIN = hashedPin;

    // Send via EmailJS
    const templateParams = { user_email: currentEmail, user_pin: newPin };
    await emailjs.send('service_2ucolxw', 'template_2lc2llr', templateParams);

    alert("✅ New PIN sent to your email! Please check your inbox or spam folder.");
    
    // Redirect after confirmation
    window.location.href = "home.html";
  } catch (err) {
    console.error("❌ Forgot PIN error:", err);
    alert("Failed to send PIN. Try again later.");
  }
};

// --- SHA-256 helper (for hashing PIN) ---
async function sha256(message) {
  const msgBuffer = new TextEncoder().encode(message);
  const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
  return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2,'0')).join('');
};



// --- Reset PIN button ---
document.getElementById("resetPinBtn").onclick = () => {
  if (!currentPIN) { alert("Login first!"); return; }
  document.getElementById("pinInput").classList.add("hidden");
  document.getElementById("resetPinInputs").classList.remove("hidden");
  document.getElementById("pinTitle").textContent = "Reset PIN";
  document.getElementById("pinActionBtn").textContent = "Save New PIN";
};

// --- Send PIN via EmailJS ---
function sendEmailPin(pin, email) {
  const templateParams = { user_email: email, user_pin: pin };
  // don’t block redirect — just log result
  emailjs.send('service_2ucolxw', 'template_2lc2llr', templateParams)
    .then(() => { console.log("✅ PIN email sent"); })
    .catch(err => { console.error("❌ Email send error:", err); });
}
</script>



</body>
</html>








