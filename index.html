<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Personal Website</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f8fafc;
      overflow-x: hidden;
    }
    .animate-card {
      animation: fadeSlideUp 0.8s ease-out forwards;
    }
    @keyframes fadeSlideUp {
      0% { opacity: 0; transform: translateY(40px) scale(0.95); }
      100% { opacity: 1; transform: translateY(0) scale(1); }
    }
    .btn-hover {
      transition: all 0.3s ease;
    }
    .btn-hover:hover {
      transform: scale(1.05) translateY(-3px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.2);
      background-color: #0d6efd;
      color: white;
    }
    #msgBox {
      display: none;
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 10px;
      background: #eee;
      border: 1px solid #ccc;
      border-radius: 5px;
      z-index: 999;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col justify-between">

  <!-- Navbar -->
  <nav class="bg-white shadow-md p-4">
    <div class="container mx-auto flex justify-between items-center">
      <div class="text-xl font-bold text-black flex items-center gap-2">
        <i class="fas fa-user-circle text-2xl text-blue-500"></i>
        <span class="text-xl font-bold">My Personal Website</span>
      </div>
    </div>
  </nav>

  <!-- Main -->
  <main class="flex-grow flex items-center justify-center bg-gray-100 px-4 w-full space-y-6 flex-col">

    <!-- Google Login Card -->
    <div id="loginCard" class="border-2 border-gray-200 rounded-2xl p-8 sm:p-10 shadow-xl bg-white w-full max-w-sm sm:max-w-md text-center animate-card">
      <h2 class="text-xl sm:text-2xl font-semibold mb-6 text-gray-700">Login with Google</h2>
      <button id="googleLoginBtn" class="flex items-center justify-center gap-3 text-lg sm:text-xl font-medium px-6 sm:px-8 py-3 sm:py-4 rounded-full bg-white text-gray-800 border-2 border-blue-500 shadow-md btn-hover mx-auto">
        <img src="https://developers.google.com/identity/images/g-logo.png" class="w-6 h-6 sm:w-7 sm:h-7"> Sign in with Google
      </button>
    </div>

    <!-- Quick Message Box -->
    <div id="msgBox"></div>

    <!-- PIN Card -->
    <div id="pinCard" class="hidden border-2 border-gray-200 rounded-2xl p-8 sm:p-10 shadow-xl bg-white w-full max-w-sm sm:max-w-md text-center animate-card">
      <h2 id="pinTitle" class="text-xl sm:text-2xl font-semibold mb-6 text-gray-700">Enter PIN</h2>

      <!-- Standard PIN input -->
      <input id="pinInput" type="password" maxlength="6" placeholder="Enter 4-6 digit PIN" class="w-full p-3 border rounded-lg mb-4 text-center"/>

      <!-- Reset PIN inputs -->
      <div id="resetPinInputs" class="hidden flex flex-col gap-3 mb-4">
        <input id="currentPinInput" type="password" maxlength="6" placeholder="Current PIN" class="w-full p-3 border rounded-lg text-center"/>
        <input id="newPinInput" type="password" maxlength="6" placeholder="New PIN" class="w-full p-3 border rounded-lg text-center"/>
        <input id="confirmNewPinInput" type="password" maxlength="6" placeholder="Confirm New PIN" class="w-full p-3 border rounded-lg text-center"/>
      </div>

      <button id="pinActionBtn" class="w-full py-3 rounded-lg bg-blue-500 text-white font-semibold btn-hover mb-2"></button>
      <p class="mt-2 text-sm text-blue-600 cursor-pointer hover:underline" id="forgotPinBtn">Forgot PIN?</p>
      <p class="mt-1 text-sm text-blue-600 cursor-pointer hover:underline" id="resetPinBtn">Reset PIN</p>
    </div>

  </main>

  <!-- Footer -->
  <footer class="bg-white text-gray-700 text-center p-4 border-t text-sm sm:text-base">
    &copy; 2025 MyFinance Tracker | All Rights Reserved.
  </footer>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3.2.0/dist/email.min.js"></script>
  <script>
    emailjs.init("NbamX634Y_o570cNw"); // Your EmailJS public key
  </script>

  <!-- Argon2 Browser -->
  <script src="https://cdn.jsdelivr.net/npm/argon2-browser/dist/argon2.min.js"></script>

  <!-- Main Script -->
  <script>
  // ---------------- Firebase ----------------
  const firebaseConfig = {
    apiKey: "AIzaSyB78RTVCg0cmSPp7A1RJyyAgBuCeolO0cc",
    authDomain: "sk12-58e9e.firebaseapp.com",
    projectId: "sk12-58e9e",
    storageBucket: "sk12-58e9e.appspot.com",
    messagingSenderId: "470207874652",
    appId: "1:470207874652:web:67ba1cf3629b7e5b144899"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const provider = new firebase.auth.GoogleAuthProvider();

  let currentUID = null, currentEmail = null, currentPIN = null;
  let isFirstTime = false;

  // ---------------- Helper Functions ----------------
  // This function is now faster by removing the Argon2 fallback
  async function hashPIN(pin) {
    const buf = new TextEncoder().encode(pin);
    const hashBuf = await crypto.subtle.digest('SHA-256', buf);
    return Array.from(new Uint8Array(hashBuf)).map(b => b.toString(16).padStart(2, '0')).join('');
  }
  
  function showMsg(msg, success = true) {
    const el = document.getElementById("msgBox");
    el.textContent = msg;
    el.style.color = success ? "green" : "red";
    el.style.display = "block";
    setTimeout(() => el.style.display = "none", 4000);
  }

  function sendEmailPin(pin, email) {
    emailjs.send('service_2ucolxw', 'template_2lc2llr', { user_email: email, user_pin: pin })
      .then(() => console.log("✅ PIN email sent"))
      .catch(e => console.error("❌ Email error", e));
  }

  async function getLock() {
    const doc = await db.collection("users").doc(currentUID).get();
    if (!doc.exists) return { attempts: 0, lockUntil: 0 };
    const d = doc.data();
    return { attempts: d.attempts || 0, lockUntil: d.lockUntil?.toMillis() || 0 };
  }

  async function updateLock(attempts, lockUntil = null) {
    const upd = { attempts };
    if (lockUntil) upd.lockUntil = firebase.firestore.Timestamp.fromMillis(lockUntil);
    db.collection("users").doc(currentUID).update(upd);
  }

  // ---------------- Event Handlers ----------------
  // Google Login
  document.getElementById("googleLoginBtn").onclick = async () => {
    try {
      const result = await auth.signInWithPopup(provider);
      currentUID = result.user.uid;
      currentEmail = result.user.email;

      const doc = await db.collection("users").doc(currentUID).get();
      document.getElementById("loginCard").classList.add("hidden");
      document.getElementById("pinCard").classList.remove("hidden");

      if (!doc.exists) {
        isFirstTime = true;
        document.getElementById("pinTitle").textContent = "Set Your PIN";
        document.getElementById("pinActionBtn").textContent = "Set PIN";
      } else {
        const data = doc.data();
        currentPIN = data.pin;
        document.getElementById("pinTitle").textContent = "Enter PIN";
        document.getElementById("pinActionBtn").textContent = "Verify PIN";
      }
    } catch (e) {
      showMsg("Login failed: " + e.message, false);
    }
  }

  // PIN Action
  document.getElementById("pinActionBtn").onclick = async () => {
    const resetInputs = document.getElementById("resetPinInputs");
    const pinInput = document.getElementById("pinInput").value;

    if (!pinInput && resetInputs.classList.contains("hidden")) {
      showMsg("Enter 4-6 digit PIN", false);
      return;
    }

    // Reset PIN
    if (!resetInputs.classList.contains("hidden")) {
      const cur = document.getElementById("currentPinInput").value;
      const newPin = document.getElementById("newPinInput").value;
      const conf = document.getElementById("confirmNewPinInput").value;

      if (!cur || !newPin || !conf) {
        showMsg("Fill all fields", false);
        return;
      }
      const hashedCur = await hashPIN(cur);
      if (hashedCur !== currentPIN) {
        showMsg("❌ Current PIN incorrect", false);
        return;
      }
      if (newPin.length < 4) {
        showMsg("PIN must be 4-6 digits", false);
        return;
      }
      if (newPin !== conf) {
        showMsg("❌ New PINs do not match", false);
        return;
      }

      const hashedNew = await hashPIN(newPin);
      currentPIN = hashedNew;
      db.collection("users").doc(currentUID).update({ pin: hashedNew, attempts: 0, lockUntil: null });
      showMsg("✅ PIN reset! Redirecting...");
      setTimeout(() => window.location.href = "index.html", 5000);
      return;
    }

    // First-time setup
if (isFirstTime) {
  if (pinInput.length < 4) {
    showMsg("PIN must be 4-6 digits", false);
    return;
  }
  const hashed = await hashPIN(pinInput);
  currentPIN = hashed;
  db.collection("users").doc(currentUID).set({ pin: hashed, attempts: 0, lockUntil: null });
  showMsg("✅ PIN set"); // will now display for 5 seconds
  return;
}


    // Normal login
    const hashed = await hashPIN(pinInput);
    const { attempts, lockUntil } = await getLock();
    const now = Date.now();

    if (lockUntil && now < lockUntil) {
      const mins = Math.ceil((lockUntil - now) / 60000);
      showMsg(`⛔ Locked! Wait ${mins} min`, false);
      return;
    }

    if (hashed === currentPIN) {
      updateLock(0);

      setTimeout(() => window.location.href = "home.html");
    } else {
      let newAtt = attempts + 1;
      let newLock = null;
      if (newAtt === 3) newLock = now + 5 * 60 * 1000;
      if (newAtt >= 5) newLock = now + 24 * 60 * 60 * 1000;
      updateLock(newAtt, newLock);
      if (newLock) {
        const msg = newAtt === 3 ? "5 mins" : "24 hrs";
        showMsg(`⛔ Too many wrong attempts! Locked ${msg}`, false);
      } else showMsg(`❌ Wrong PIN! Attempts: ${newAtt}/5`, false);
    }
  }

  // Forgot PIN
  document.getElementById("forgotPinBtn").onclick = async () => {
    if (!currentEmail) {
      showMsg("Login first!", false);
      return;
    }
    const newPin = Math.floor(1000 + Math.random() * 9000).toString();
    const hashed = await hashPIN(newPin);
    currentPIN = hashed;
    db.collection("users").doc(currentUID).update({ pin: hashed, attempts: 0, lockUntil: null });
    showMsg("✅ New PIN sent! Check your email.", true);
    document.getElementById("pinInput").value = "";
    sendEmailPin(newPin, currentEmail); // This function is now the last line
  }

  // Reset PIN button
  document.getElementById("resetPinBtn").onclick = () => {
    if (!currentPIN) {
      showMsg("Login first!", false);
      return;
    }
    document.getElementById("pinInput").classList.add("hidden");
    document.getElementById("resetPinInputs").classList.remove("hidden");
    document.getElementById("pinTitle").textContent = "Reset PIN";
    document.getElementById("pinActionBtn").textContent = "Save New PIN";
  }
  </script>
  </script>

</body>
</html>











