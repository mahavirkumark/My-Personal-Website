<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>My Personal Website</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
body { font-family:'Segoe UI',sans-serif; background-color:#f8fafc; overflow-x:hidden; }
.animate-card { animation:fadeSlideUp 0.8s ease-out forwards; }
@keyframes fadeSlideUp {0%{opacity:0;transform:translateY(40px) scale(0.95);}100%{opacity:1;transform:translateY(0) scale(1);} }
.btn-hover { transition: all 0.3s ease; }
.btn-hover:hover { transform:scale(1.05) translateY(-3px); box-shadow:0 10px 20px rgba(0,0,0,0.2); background-color:#0d6efd; color:white; }
</style>
</head>
<body class="min-h-screen flex flex-col justify-between">

<nav class="bg-white shadow-md p-4">
  <div class="container mx-auto flex justify-between items-center">
    <div class="text-xl font-bold text-black flex items-center gap-2">
      <i class="fas fa-user-circle text-2xl text-blue-500"></i>
      <span class="text-xl font-bold">My Personal Website</span>
    </div>
  </div>
</nav>

<main class="flex-grow flex items-center justify-center bg-gray-100 px-4 w-full">

  <!-- Google Login -->
  <div id="loginCard" class="border-2 border-gray-200 rounded-2xl p-8 sm:p-10 shadow-xl bg-white w-full max-w-sm sm:max-w-md text-center animate-card">
    <h2 class="text-xl sm:text-2xl font-semibold mb-6 text-gray-700">Login with Google</h2>
    <button id="googleLoginBtn" class="flex items-center justify-center gap-3 text-lg sm:text-xl font-medium px-6 sm:px-8 py-3 sm:py-4 rounded-full bg-white text-gray-800 border-2 border-blue-500 shadow-md btn-hover mx-auto">
      <img src="https://developers.google.com/identity/images/g-logo.png" class="w-6 h-6 sm:w-7 sm:h-7"> Sign in with Google
    </button>
  </div>

  <!-- PIN Card -->
  <div id="pinCard" class="hidden border-2 border-gray-200 rounded-2xl p-8 sm:p-10 shadow-xl bg-white w-full max-w-sm sm:max-w-md text-center animate-card">

    <h2 id="pinTitle" class="text-xl sm:text-2xl font-semibold mb-6 text-gray-700">Enter PIN</h2>

    <!-- Standard PIN input -->
    <input id="pinInput" type="password" maxlength="6" placeholder="Enter 4-6 digit PIN" class="w-full p-3 border rounded-lg mb-4 text-center"/>

    <!-- Reset PIN inputs (hidden initially) -->
    <div id="resetPinInputs" class="hidden flex flex-col gap-3 mb-4">
      <input id="currentPinInput" type="password" maxlength="6" placeholder="Current PIN" class="w-full p-3 border rounded-lg text-center"/>
      <input id="newPinInput" type="password" maxlength="6" placeholder="New PIN" class="w-full p-3 border rounded-lg text-center"/>
      <input id="confirmNewPinInput" type="password" maxlength="6" placeholder="Confirm New PIN" class="w-full p-3 border rounded-lg text-center"/>
    </div>

    <button id="pinActionBtn" class="w-full py-3 rounded-lg bg-blue-500 text-white font-semibold btn-hover mb-2"></button>
    <p class="mt-2 text-sm text-blue-600 cursor-pointer hover:underline" id="forgotPinBtn">Forgot PIN?</p>
    <p class="mt-1 text-sm text-blue-600 cursor-pointer hover:underline" id="resetPinBtn">Reset PIN</p>

  </div>

</main>

<footer class="bg-white text-gray-700 text-center p-4 border-t text-sm sm:text-base">
  &copy; 2025 MyFinance Tracker | All Rights Reserved.
</footer>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>

<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3.2.0/dist/email.min.js"></script>
<script>
emailjs.init("NbamX634Y_o570cNw"); // Your EmailJS public key
</script>

<!-- Include Argon2 Browser -->
<script src="https://cdn.jsdelivr.net/npm/argon2-browser/dist/argon2.min.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyB78RTVCg0cmSPp7A1RJyyAgBuCeolO0cc",
  authDomain: "sk12-58e9e.firebaseapp.com",
  projectId: "sk12-58e9e",
  storageBucket: "sk12-58e9e.appspot.com",
  messagingSenderId: "470207874652",
  appId: "1:470207874652:web:67ba1cf3629b7e5b144899"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const provider = new firebase.auth.GoogleAuthProvider();

let currentUID = null, currentEmail = null, currentPIN = null;
let isFirstTime = false;

// --- Argon2 Hash ---
async function hashPin(pin) {
  const result = await argon2.hash({ pass: pin, salt: crypto.getRandomValues(new Uint8Array(16)) });
  return result.encoded;
}

// --- Argon2 Verify ---
async function verifyPin(hashed, pin) {
  return await argon2.verify({ pass: pin, encoded: hashed });
}

// --- EmailJS send ---
function sendEmailPin(pin, email) {
  const templateParams = { user_email: email, user_pin: pin };
  emailjs.send('service_2ucolxw', 'template_2lc2llr', templateParams)
    .then(() => console.log("✅ PIN email sent"))
    .catch(err => console.error("❌ Email send error:", err));
}

// --- Google Login ---
document.getElementById("googleLoginBtn").onclick = async () => {
  try {
    const result = await auth.signInWithPopup(provider);
    currentUID = result.user.uid;
    currentEmail = result.user.email;

    const doc = await db.collection("users").doc(currentUID).get();
    document.getElementById("loginCard").classList.add("hidden");
    document.getElementById("pinCard").classList.remove("hidden");

    if (!doc.exists) {
      isFirstTime = true;
      document.getElementById("pinTitle").textContent = "Set Your PIN";
      document.getElementById("pinActionBtn").textContent = "Set PIN";
    } else {
      const data = doc.data();
      currentPIN = data.pin;
      document.getElementById("pinTitle").textContent = "Enter PIN";
      document.getElementById("pinActionBtn").textContent = "Verify PIN";
    }

  } catch(e) { alert("Login failed: " + e.message); }
};

// --- Get attempts & lock ---
async function getLockInfo() {
  const doc = await db.collection("users").doc(currentUID).get();
  if (!doc.exists) return { attempts: 0, lockUntil: 0 };
  const data = doc.data();
  return { attempts: data.attempts || 0, lockUntil: data.lockUntil?.toMillis() || 0 };
}

// --- Update attempts & lock ---
async function updateLockInfo(attempts, lockUntil = null) {
  const updateData = { attempts };
  if (lockUntil) updateData.lockUntil = firebase.firestore.Timestamp.fromMillis(lockUntil);
  await db.collection("users").doc(currentUID).update(updateData);
}

// --- PIN Action Button ---
document.getElementById("pinActionBtn").onclick = async () => {
  const resetInputs = document.getElementById("resetPinInputs");
  const pinInput = document.getElementById("pinInput").value;

  if (!pinInput && resetInputs.classList.contains("hidden")) { alert("Enter 4-6 digit PIN"); return; }

  // --- Reset PIN ---
  if (!resetInputs.classList.contains("hidden")) {
    const currentPin = document.getElementById("currentPinInput").value;
    const newPin = document.getElementById("newPinInput").value;
    const confirmPin = document.getElementById("confirmNewPinInput").value;

    if (!currentPin || !newPin || !confirmPin) { alert("Fill all fields"); return; }
    if (!(await verifyPin(currentPIN, currentPin))) { alert("❌ Current PIN is incorrect"); return; }
    if (newPin.length < 4) { alert("New PIN must be 4-6 digits"); return; }
    if (newPin !== confirmPin) { alert("❌ New PIN and Confirm PIN do not match"); return; }

    const hashedNew = await hashPin(newPin);
    await db.collection("users").doc(currentUID).update({ pin: hashedNew, attempts: 0, lockUntil: null });
    currentPIN = hashedNew;
    sendEmailPin(newPin, currentEmail);
    alert("✅ PIN reset successfully! Check your email.");
    window.location.href = "home.html";
    return;
  }

  // --- First-time PIN ---
  if (isFirstTime) {
    if (!pinInput || pinInput.length < 4) { alert("Enter 4-6 digit PIN"); return; }
    const hashedPin = await hashPin(pinInput);
    await db.collection("users").doc(currentUID).set({ pin: hashedPin, attempts: 0, lockUntil: null });
    currentPIN = hashedPin;
    sendEmailPin(pinInput, currentEmail);
    alert("✅ PIN set successfully! Check your email.");
    window.location.href = "home.html";
    return;
  }

  // --- Normal login ---
  const { attempts, lockUntil } = await getLockInfo();
  const now = Date.now();

  if (lockUntil && now < lockUntil) {
    const mins = Math.ceil((lockUntil - now)/60000);
    alert(`⛔ Too many wrong attempts! Try again in ${mins} minutes.`);
    return;
  }

  const isValid = await verifyPin(currentPIN, pinInput);

  if (isValid) {
    await updateLockInfo(0);
    window.location.href = "home.html";
  } else {
    let newAttempts = attempts + 1;
    let newLock = null;

    if (newAttempts === 3) newLock = now + 5*60*1000; // 5 mins
    if (newAttempts >= 5) newLock = now + 24*60*60*1000; // 24 hrs

    await updateLockInfo(newAttempts, newLock);
    if (newLock) {
      const mins = newAttempts === 3 ? 5 : 0;
      const hrs = newAttempts >= 5 ? 24 : 0;
      alert(`⛔ Too many wrong attempts! Locked for ${hrs ? hrs+" hrs" : mins+" mins"}`);
    } else {
      alert(`❌ Wrong PIN! Attempts: ${newAttempts}/5`);
    }
  }
};

// --- Forgot PIN ---
document.getElementById("forgotPinBtn").onclick = async () => {
  if (!currentEmail) { alert("Login first!"); return; }

  const newPin = Math.floor(1000 + Math.random() * 9000).toString();
  const hashedPin = await hashPin(newPin);
  await db.collection("users").doc(currentUID).update({ pin: hashedPin, attempts: 0, lockUntil: null });
  currentPIN = hashedPin;
  sendEmailPin(newPin, currentEmail);
  alert("✅ New PIN sent to your email! Enter it below to login.");
  document.getElementById("pinInput").value = "";
};

// --- Reset PIN button ---
document.getElementById("resetPinBtn").onclick = () => {
  if (!currentPIN) { alert("Login first!"); return; }
  document.getElementById("pinInput").classList.add("hidden");
  document.getElementById("resetPinInputs").classList.remove("hidden");
  document.getElementById("pinTitle").textContent = "Reset PIN";
  document.getElementById("pinActionBtn").textContent = "Save New PIN";
};
</script>




</body>
</html>










