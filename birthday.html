<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Personal Website - Birthday Saver & Contacts</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body class="bg-gray-100 font-sans antialiased">

    <nav class="bg-white shadow-lg fixed w-full z-50">
        <div class="container mx-auto flex justify-between items-center p-4 md:px-8">
            <div class="flex items-center gap-2 text-xl font-bold text-gray-800">
                <i class="fas fa-user-circle text-indigo-500"></i> My Personal Website
            </div>
            <div class="hidden md:flex space-x-6 text-gray-600 font-medium">
                <a href="home.html" class="flex items-center gap-2 hover:text-indigo-500 transition duration-300"><i class="fas fa-house"></i> Home</a>
                <a href="address.html" class="flex items-center gap-2 hover:text-indigo-500 transition duration-300"><i class="fas fa-tasks"></i> Address</a>
                <a href="password.html" class="flex items-center gap-2 hover:text-indigo-500 transition duration-300"><i class="fas fa-key"></i> Passwords</a>
                <a href="income.html" class="flex items-center gap-2 hover:text-indigo-500 transition duration-300"><i class="fas fa-wallet"></i> Income</a>
                <a href="links.html" class="flex items-center gap-2 hover:text-indigo-500 transition duration-300"><i class="fas fa-link"></i> Links</a>
                <a href="calendar.html" class="flex items-center gap-2 hover:text-indigo-500 transition duration-300"><i class="fas fa-calendar-alt"></i> Calendar</a>
            </div>
            <div class="hidden md:flex items-center gap-4">
                <div class="text-right">
                    <p id="userName" class="font-bold text-gray-900">Loading...</p>
                    <p id="userEmail" class="text-sm text-gray-500">Loading...</p>
                </div>
                <img id="userPhoto" src="https://via.placeholder.com/40" class="w-10 h-10 rounded-full border-2 border-indigo-500">
                <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-full hover:bg-red-600 transition duration-300">Logout</button>
            </div>
            <button id="menu-btn" class="md:hidden text-gray-700 text-2xl"><i class="fas fa-bars"></i></button>
        </div>
        <div id="mobileMenu" class="hidden md:hidden flex flex-col px-4 pb-4 space-y-2 text-sm text-gray-700 font-medium bg-gray-50">
            <a href="home.html" class="flex items-center gap-2 p-2 rounded hover:bg-gray-200"><i class="fas fa-house"></i> Home</a>
            <a href="address.html" class="flex items-center gap-2 p-2 rounded hover:bg-gray-200"><i class="fas fa-tasks"></i> Address</a>
            <a href="password.html" class="flex items-center gap-2 p-2 rounded hover:bg-gray-200"><i class="fas fa-key"></i> Passwords</a>
            <a href="income.html" class="flex items-center gap-2 p-2 rounded hover:bg-gray-200"><i class="fas fa-wallet"></i> Income</a>
            <a href="links.html" class="flex items-center gap-2 p-2 rounded hover:bg-gray-200"><i class="fas fa-link"></i> Links</a>
            <a href="calendar.html" class="flex items-center gap-2 p-2 rounded hover:bg-gray-200"><i class="fas fa-calendar-alt"></i> Calendar</a>
            <div class="border-t border-gray-300 mt-2 pt-2">
                <p id="mobileUserName" class="font-bold text-gray-900">Loading...</p>
                <p id="mobileUserEmail" class="text-xs text-gray-500">Loading...</p>
                <button onclick="logout()" class="bg-red-500 text-white px-3 py-2 rounded-full hover:bg-red-600 mt-2 w-full">Logout</button>
            </div>
        </div>
    </nav>

    <main class="pt-28 p-4 md:p-8">
        <div class="container mx-auto">
            <h1 class="text-3xl font-extrabold text-center text-gray-800 mb-8">ðŸŽ‰ Birthday Saver & Contacts ðŸŽ‰</h1>
            <div class="flex flex-wrap lg:flex-nowrap justify-center gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-lg w-full sm:w-1/2 lg:w-1/3 transform hover:scale-105 transition duration-300">
                    <h2 class="text-2xl font-semibold text-center text-gray-700 mb-4 flex items-center justify-center gap-2"><i class="fas fa-gift text-red-500"></i> Today's Birthdays</h2>
                    <ul id="today-list" class="space-y-3">
                        <li class="text-gray-500 text-center">No birthdays today.</li>
                    </ul>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg w-full sm:w-1/2 lg:w-1/3 transform hover:scale-105 transition duration-300">
                    <h2 class="text-2xl font-semibold text-center text-gray-700 mb-4 flex items-center justify-center gap-2"><i class="fas fa-calendar-day text-blue-500"></i> Tomorrow's Birthdays</h2>
                    <ul id="tomorrow-list" class="space-y-3">
                        <li class="text-gray-500 text-center">No birthdays tomorrow.</li>
                    </ul>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg w-full sm:w-full lg:w-1/3 transform hover:scale-105 transition duration-300">
                    <h2 class="text-2xl font-semibold text-center text-gray-700 mb-4 flex items-center justify-center gap-2"><i class="fas fa-calendar-alt text-purple-500"></i> Upcoming Birthdays</h2>
                    <ul id="upcoming-birthdays-list" class="space-y-3">
                        <li class="text-center text-gray-500 p-4">Loading upcoming birthdays...</li>
                    </ul>
                </div>
            </div>

            <div class="flex flex-col md:flex-row gap-8">
                <div class="bg-white p-6 rounded-xl shadow-lg md:w-1/3 h-fit">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Add a Birthday</h2>
                    <form id="add-birthday-form" class="space-y-5">
                        <div>
                            <input type="text" id="name" required placeholder="Name" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                        </div>
                        <div>
                            <input type="text" id="mobile" placeholder="Mobile Number (Optional)" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                        </div>
                        <div>
                            <input type="date" id="birthdate" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                            <p class="text-xs text-gray-500 mt-1">Leave blank to enter age manually, or enter a full date to auto-calculate.</p>
                        </div>
                        <div>
                            <input type="number" id="age" placeholder="Age (Optional)" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                        </div>
                        <div id="notes-container" class="space-y-4 hidden">
                            <h3 class="text-lg font-semibold text-gray-700 pt-2 border-t border-gray-200 mt-4">Notes (Optional)</h3>
                            <div id="notes-fields">
                                <div class="flex items-center gap-2 mb-2">
                                    <input type="text" placeholder="Note Title (e.g., Gift Idea)" class="w-1/3 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 note-title">
                                    <input type="text" placeholder="Note Content (e.g., A new book)" class="w-2/3 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 note-content">
                                </div>
                            </div>
                            <button type="button" id="add-note-btn" class="text-indigo-500 text-sm font-medium hover:text-indigo-700 transition duration-150 ease-in-out">
                                <i class="fas fa-plus-circle mr-1"></i> Add Another Note
                            </button>
                        </div>
                        <button type="button" id="toggle-notes-btn" class="w-full text-indigo-600 font-semibold py-3 px-4 rounded-lg bg-indigo-50 hover:bg-indigo-100 transition duration-150 ease-in-out">
                            <i class="fas fa-plus mr-2"></i> Add Notes
                        </button>
                        <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700 transition duration-150 ease-in-out">
                            <i class="fas fa-save mr-2"></i> Save Birthday
                        </button>
                    </form>
                </div>

                <div class="md:w-2/3 space-y-8">
                    
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">All Contacts & Birthdays</h2>
                        <div class="relative mb-4">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                            <input type="text" id="searchInput" placeholder="Search by name..." class="w-full pl-10 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <ul id="all-items-list" class="space-y-3 max-h-96 overflow-y-auto">
                            <li class="text-center text-gray-500 p-4">Loading contacts and birthdays...</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="edit-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex justify-center items-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-md overflow-y-auto max-h-[90vh] relative">
            <div class="flex justify-between items-center pb-3 border-b border-gray-200 mb-4">
                <h3 class="text-2xl font-bold" id="edit-modal-title">Edit Birthday</h3>
                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-700 text-xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="edit-birthday-form" class="space-y-4">
                <input type="hidden" id="edit-id">
                <div>
                    <label for="edit-name" class="block text-sm font-medium text-gray-700">Name:</label>
                    <input type="text" id="edit-name" required class="mt-1 block w-full rounded-lg border-gray-300 p-2">
                </div>
                <div>
                    <label for="edit-mobile" class="block text-sm font-medium text-gray-700">Mobile No:</label>
                    <input type="text" id="edit-mobile" class="mt-1 block w-full rounded-lg border-gray-300 p-2">
                </div>
                <div>
                    <label for="edit-birthdate" class="block text-sm font-medium text-gray-700">Date:</label>
                    <input type="date" id="edit-birthdate" class="mt-1 block w-full rounded-lg border-gray-300 p-2">
                </div>
                <div>
                    <label for="edit-age" class="block text-sm font-medium text-gray-700">Age:</label>
                    <input type="number" id="edit-age" class="mt-1 block w-full rounded-lg border-gray-300 p-2">
                </div>
                <div id="edit-notes-container" class="space-y-4"></div>
                <button type="button" id="edit-add-note-btn" class="text-indigo-500 text-sm font-medium hover:text-indigo-700 transition duration-150 ease-in-out">
                    <i class="fas fa-plus-circle mr-1"></i> Add Another Note
                </button>
                <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700">Save Changes</button>
            </form>
        </div>
    </div>

    <script>
        // --- Firebase Configuration (REPLACE WITH YOUR OWN CONFIG) ---
        const firebaseConfig = {
          apiKey: "AIzaSyB78RTVCg0cmSPp7A1RJyyAgBuCeolO0cc",
          authDomain: "sk12-58e9e.firebaseapp.com",
          projectId: "sk12-58e9e",
          storageBucket: "sk12-58e9e.appspot.com",
          messagingSenderId: "470207874652",
          appId: "1:470207874652:web:67ba1cf3629b7e5b144899"
        };
        
        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const database = firebase.database();
        const auth = firebase.auth();

        // --- Global Variables ---
        let currentUserId = null;
        let allBirthdays = {};
        let allContacts = {};
        
        // Contacts from the VCard file. You will only need this to import them ONE time.
        const vcardContacts = [
            { id: 'vc1', name: 'Samsung Helpline', phone: '+91 1800 407 267 864' },
            { id: 'vc2', name: 'ATHARAV DOLASðŸ˜Ž', phone: '+91 98608 92299' },
            { id: 'vc3', name: 'Hardik', phone: '+91 75585 15739' },
            { id: 'vc4', name: 'Symphony Phone Number', phone: '+91 95109 76161' },
            { id: 'vc5', name: 'Ganesh', phone: '+91 83080 66627' },
            { id: 'vc6', name: 'Harsh', phone: '+91 87881 48821' },
            { id: 'vc7', name: 'omlonkar447', phone: '+91 74473 81139' },
            { id: 'vc8', name: 'AADITYA AMAR', phone: '+91 94037 45013' },
            { id: 'vc9', name: 'Vilas Kulkarni', phone: '+91 98222 33913' },
            { id: 'vc10', name: 'Swati Kulkarni', phone: '+91 88886 42200' },
            { id: 'vc11', name: 'Jaya Raut', phone: '+91 96738 86002' },
            { id: 'vc12', name: 'Adwaiyata', phone: '+91 98508 12323' },
            { id: 'vc13', name: 'Abhishek', phone: '+91 98819 83721' },
            { id: 'vc14', name: 'Kalyani Khangan', phone: '+91 77220 02989' },
            { id: 'vc15', name: 'Jyoti', phone: '+91 94061 58783' },
            { id: 'vc16', name: 'Anand', phone: '+91 99750 29539' },
            { id: 'vc17', name: 'Amit Mainde Papad Wala', phone: '+91 89832 60793' },
        ];


        // --- DOM Elements ---
        const menuBtn = document.getElementById('menu-btn');
        const mobileMenu = document.getElementById('mobileMenu');
        const addBirthdayForm = document.getElementById('add-birthday-form');
        const allItemsList = document.getElementById('all-items-list');
        const searchInput = document.getElementById('searchInput');
        const todayList = document.getElementById('today-list');
        const tomorrowList = document.getElementById('tomorrow-list');
        const upcomingList = document.getElementById('upcoming-birthdays-list');
        const editModal = document.getElementById('edit-modal');
        const closeBtn = document.getElementById('close-modal-btn');
        const editForm = document.getElementById('edit-birthday-form');
        const notesContainer = document.getElementById('notes-container');
        const toggleNotesBtn = document.getElementById('toggle-notes-btn');
        const notesFields = document.getElementById('notes-fields');
        const addNoteBtn = document.getElementById('add-note-btn');
        const editNotesContainer = document.getElementById('edit-notes-container');
        const editAddNoteBtn = document.getElementById('edit-add-note-btn');
        const editNameInput = document.getElementById('edit-name');
        const editMobileInput = document.getElementById('edit-mobile');
        const editDateInput = document.getElementById('edit-birthdate');
        const editAgeInput = document.getElementById('edit-age');
        const editIdInput = document.getElementById('edit-id');


        // --- Event Listeners ---
        menuBtn.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });

        toggleNotesBtn.addEventListener('click', () => {
            notesContainer.classList.toggle('hidden');
            if (notesContainer.classList.contains('hidden')) {
                toggleNotesBtn.innerHTML = '<i class="fas fa-plus mr-2"></i> Add Notes';
            } else {
                toggleNotesBtn.innerHTML = '<i class="fas fa-minus mr-2"></i> Hide Notes';
            }
        });

        addNoteBtn.addEventListener('click', () => {
            addNoteField(notesFields);
        });

        editAddNoteBtn.addEventListener('click', () => {
            addNoteField(editNotesContainer);
        });

        addBirthdayForm.addEventListener('submit', handleAddBirthday);
        editForm.addEventListener('submit', handleEditBirthday);
        closeBtn.addEventListener('click', () => editModal.classList.add('hidden'));

        allItemsList.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            
            const listItem = e.target.closest('li');
            const birthdayId = listItem.dataset.birthdayId;
            const contactId = listItem.dataset.contactId;
            const name = listItem.dataset.name;

            if (btn.classList.contains('delete-btn')) {
                 if (confirm(`Are you sure you want to delete ${name}? This action cannot be undone.`)) {
                     if (birthdayId) {
                         deleteBirthday(birthdayId);
                     }
                     if (contactId) {
                         deleteContact(contactId);
                     }
                 }
            } else if (btn.classList.contains('edit-btn')) {
                if (confirm(`Do you want to edit the details for ${name}?`)) {
                    if(birthdayId) {
                       openEditModal(birthdayId);
                    }
                }
            } else if (btn.classList.contains('add-birthday-btn')) {
                document.getElementById('name').value = name;
                document.getElementById('mobile').value = listItem.dataset.mobile || '';
                document.getElementById('birthdate').value = '';
                document.getElementById('age').value = '';
            } else if (btn.classList.contains('share-contact-btn')) {
                const contact = allContacts[contactId];
                if (contact) {
                    shareContact(contact);
                } else {
                    console.error("No contact details to share for this entry.");
                }
            } else if (btn.classList.contains('share-birthday-btn')) {
                const birthday = allBirthdays[birthdayId];
                if (birthday) {
                    shareBirthday(birthday);
                } else {
                    console.error("No birthday details to share for this entry.");
                }
            }
        });

        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            renderAllItems(searchTerm);
        });


        // --- Helper Functions ---
        function addNoteField(container, title = '', content = '') {
            const noteDiv = document.createElement('div');
            noteDiv.className = 'flex items-center gap-2 mb-2';
            noteDiv.innerHTML = `
                <input type="text" value="${title}" placeholder="Note Title" class="w-1/3 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 note-title">
                <input type="text" value="${content}" placeholder="Note Content" class="w-2/3 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 note-content">
                <button type="button" class="text-red-500 hover:text-red-700 remove-note-btn"><i class="fas fa-times-circle"></i></button>
            `;
            container.appendChild(noteDiv);
            noteDiv.querySelector('.remove-note-btn').addEventListener('click', () => {
                noteDiv.remove();
            });
        }
        
        function parseVCard(vcardString) {
            const contacts = [];
            const vcards = vcardString.split('END:VCARD').filter(block => block.trim() !== '');
            vcards.forEach(vcardBlock => {
                const lines = vcardBlock.split('\n');
                let name = '';
                let phone = '';
                lines.forEach(line => {
                    if (line.startsWith('FN:')) {
                        name = line.substring(3).trim();
                    } else if (line.startsWith('TEL;')) {
                        const telParts = line.split(':');
                        if (telParts.length > 1) {
                            phone = telParts[1].trim();
                        }
                    }
                });
                if (name || phone) {
                    contacts.push({ name, phone });
                }
            });
            return contacts;
        }

        function calculateAge(birthdate) {
            if (!birthdate || birthdate.length < 10) return null; // Ensure full YYYY-MM-DD format
            const today = new Date();
            const birthDate = new Date(birthdate);
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        }
        
        function getNextBirthdayDate(birthdate) {
            if (!birthdate) return null;
            const today = new Date();
            const birthDate = new Date(birthdate);
            const nextBirthday = new Date(today.getFullYear(), birthDate.getMonth(), birthDate.getDate());
            if (nextBirthday < today) {
                nextBirthday.setFullYear(today.getFullYear() + 1);
            }
            return nextBirthday;
        }

        function getUpcomingBirthdays(birthdays) {
            const today = new Date();
            const upcoming = Object.values(birthdays).filter(item => {
                if (!item.birthdate) return false;
                const nextBday = getNextBirthdayDate(item.birthdate);
                const diffDays = Math.ceil((nextBday - today) / (1000 * 60 * 60 * 24));
                return diffDays > 1 && diffDays <= 6;
            }).sort((a, b) => {
                return getNextBirthdayDate(a.birthdate) - getNextBirthdayDate(b.birthdate);
            });
            return upcoming;
        }

        function getTodayAndTomorrowBirthdays(birthdays) {
            const today = new Date();
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            const todayBirthdays = Object.values(birthdays).filter(item => {
                if (!item.birthdate) return false;
                const birthDate = new Date(item.birthdate);
                return today.getMonth() === birthDate.getMonth() && today.getDate() === birthDate.getDate();
            });
            
            const tomorrowBirthdays = Object.values(birthdays).filter(item => {
                if (!item.birthdate) return false;
                const birthDate = new Date(item.birthdate);
                return tomorrow.getMonth() === birthDate.getMonth() && tomorrow.getDate() === birthDate.getDate();
            });

            return { todayBirthdays, tomorrowBirthdays };
        }

        function renderBirthdayList(listId, items) {
            const list = document.getElementById(listId);
            list.innerHTML = '';
            if (items.length === 0) {
                list.innerHTML = `<li class="text-gray-500 text-center">${listId === 'today-list' ? 'No birthdays today.' : listId === 'tomorrow-list' ? 'No birthdays tomorrow.' : 'No upcoming birthdays.'}</li>`;
                return;
            }
            items.forEach(item => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg shadow-sm';
                li.innerHTML = `
                    <div class="flex items-center gap-4">
                        <i class="fas fa-gift text-lg text-indigo-500"></i>
                        <div>
                            <p class="font-bold text-gray-900">${item.name}</p>
                            ${item.birthdate ? `<p class="text-sm text-gray-600">${new Date(item.birthdate).toLocaleDateString('en-US', { month: 'long', day: 'numeric' })}</p>` : ''}
                        </div>
                    </div>
                `;
                list.appendChild(li);
            });
        }
        
        function renderAllItems(searchTerm = '') {
            const list = document.getElementById('all-items-list');
            list.innerHTML = '';
            
            let combinedItemsMap = new Map();
            
            // Process Contacts first
            for (const key in allContacts) {
                const contact = allContacts[key];
                const item = { ...contact, contactId: key, isContact: true, isBirthday: false };
                combinedItemsMap.set(contact.name.toLowerCase(), item);
            }

            // Process Birthdays and merge with existing contacts
            for (const key in allBirthdays) {
                const birthday = allBirthdays[key];
                const existingItem = combinedItemsMap.get(birthday.name.toLowerCase());
                if (existingItem) {
                    existingItem.birthdate = birthday.birthdate;
                    existingItem.age = birthday.age;
                    existingItem.notes = birthday.notes;
                    existingItem.isBirthday = true;
                    existingItem.birthdayId = key;
                } else {
                    const item = { ...birthday, birthdayId: key, isContact: false, isBirthday: true };
                    combinedItemsMap.set(birthday.name.toLowerCase(), item);
                }
            }

            const filteredItems = Array.from(combinedItemsMap.values()).filter(item => 
                (item.name && item.name.toLowerCase().includes(searchTerm)) ||
                (item.phone && item.phone.toLowerCase().includes(searchTerm)) ||
                (item.mobile && item.mobile.toLowerCase().includes(searchTerm))
            );
            
            if (filteredItems.length === 0) {
                list.innerHTML = `<li class="text-center text-gray-500 p-4">No contacts or birthdays found.</li>`;
                return;
            }
            
            filteredItems.sort((a, b) => a.name.localeCompare(b.name));

            filteredItems.forEach(item => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between p-4 bg-gray-50 rounded-lg shadow-sm';
                li.setAttribute('data-name', item.name);
                if (item.contactId) li.setAttribute('data-contact-id', item.contactId);
                if (item.birthdayId) li.setAttribute('data-birthday-id', item.birthdayId);
                if (item.mobile) li.setAttribute('data-mobile', item.mobile);
                
                let iconHtml = '';
                if(item.isContact) {
                    iconHtml += `<i class="fas fa-address-card text-purple-500 text-2xl"></i>`;
                }
                if(item.isBirthday) {
                    iconHtml += `<i class="fas fa-birthday-cake text-red-500 text-2xl"></i>`;
                }

                let ageDisplay = '';
                if (item.birthdate) {
                    ageDisplay = `(${calculateAge(item.birthdate)} Years Old)`;
                } else if (item.age) {
                    ageDisplay = `(${item.age} Years Old)`;
                }

                let actionsHtml = '';
                if (item.isBirthday) {
                    actionsHtml = `
                        <button class="edit-btn bg-yellow-500 text-white px-3 py-2 rounded-full hover:bg-yellow-600 transition duration-300 text-sm"><i class="fas fa-edit"></i></button>
                    `;
                } else {
                    actionsHtml = `
                        <button class="add-birthday-btn bg-indigo-500 text-white px-3 py-2 rounded-full hover:bg-indigo-600 transition duration-300 text-sm">
                            <i class="fas fa-plus"></i> Add Birthday
                        </button>
                    `;
                }
                
                let shareButtonsHtml = '';
                if(item.isContact) {
                    shareButtonsHtml += `<button class="share-contact-btn bg-blue-500 text-white px-3 py-2 rounded-full hover:bg-blue-600 transition duration-300 text-sm"><i class="fas fa-mobile-alt"></i></button>`;
                }
                if(item.isBirthday) {
                    shareButtonsHtml += `<button class="share-birthday-btn bg-green-500 text-white px-3 py-2 rounded-full hover:bg-green-600 transition duration-300 text-sm"><i class="fas fa-gift"></i></button>`;
                }


                itemHtml = `
                    <div class="flex items-start gap-4 flex-grow">
                        <div class="flex-shrink-0 flex items-center gap-2">
                            ${iconHtml}
                        </div>
                        <div class="flex-grow">
                            <p class="font-bold text-gray-900">${item.name}</p>
                            ${item.mobile ? `<p class="text-sm text-gray-600"><i class="fas fa-mobile-alt mr-1"></i> ${item.mobile}</p>` : ''}
                            ${item.phone ? `<p class="text-sm text-gray-600"><i class="fas fa-phone mr-1"></i> ${item.phone}</p>` : ''}
                            ${item.isBirthday ? `
                                <p class="text-sm text-gray-600">
                                    <i class="fas fa-calendar-alt mr-1"></i> 
                                    Birthday: ${item.birthdate ? new Date(item.birthdate).toLocaleDateString('en-US', { month: 'long', day: 'numeric' }) : 'Not specified'} 
                                    ${ageDisplay}
                                </p>
                            ` : ''}
                            ${item.notes && item.notes.length > 0 ? `
                                <div class="mt-2 text-sm text-gray-500">
                                    ${item.notes.map(note => `<p><i class="fas fa-sticky-note mr-1"></i> <strong>${note.title}:</strong> ${note.content}</p>`).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    <div class="flex-shrink-0 flex items-center gap-2">
                        ${actionsHtml}
                        <button class="delete-btn bg-red-500 text-white px-3 py-2 rounded-full hover:bg-red-600 transition duration-300 text-sm"><i class="fas fa-trash-alt"></i></button>
                        ${shareButtonsHtml}
                    </div>
                `;
                li.innerHTML = itemHtml;
                list.appendChild(li);
            });
        }


        // --- Firebase Functions ---
        function handleAddBirthday(e) {
            e.preventDefault();
            const name = document.getElementById('name').value;
            const mobile = document.getElementById('mobile').value;
            const birthdate = document.getElementById('birthdate').value;
            const age = document.getElementById('age').value;
            const notes = Array.from(notesFields.querySelectorAll('div')).map(div => ({
                title: div.querySelector('.note-title').value,
                content: div.querySelector('.note-content').value,
            })).filter(note => note.title || note.content);

            const newBirthday = { name, mobile, birthdate, age, notes };
            
            if (currentUserId) {
                const newBdayRef = database.ref(`users/${currentUserId}/birthdays`).push();
                newBdayRef.set(newBirthday).then(() => {
                    addBirthdayForm.reset();
                    notesContainer.classList.add('hidden');
                    notesFields.innerHTML = `<div class="flex items-center gap-2 mb-2"><input type="text" placeholder="Note Title (e.g., Gift Idea)" class="w-1/3 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 note-title"><input type="text" placeholder="Note Content (e.g., A new book)" class="w-2/3 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 note-content"></div>`;
                    toggleNotesBtn.innerHTML = '<i class="fas fa-plus mr-2"></i> Add Notes';
                }).catch(error => {
                    console.error("Error adding birthday: ", error);
                });
            } else {
                alert("Please log in to save birthdays.");
            }
        }

        function openEditModal(id) {
            const itemToEdit = allBirthdays[id];
            if (!itemToEdit) return;

            editIdInput.value = id;
            editNameInput.value = itemToEdit.name;
            editMobileInput.value = itemToEdit.mobile || '';
            editDateInput.value = itemToEdit.birthdate || '';
            editAgeInput.value = itemToEdit.age || '';
            
            editNotesContainer.innerHTML = '';
            if (itemToEdit.notes && itemToEdit.notes.length > 0) {
                itemToEdit.notes.forEach(note => {
                    addNoteField(editNotesContainer, note.title, note.content);
                });
            } else {
                addNoteField(editNotesContainer);
            }
            
            editModal.classList.remove('hidden');
        }

        function handleEditBirthday(e) {
            e.preventDefault();
            const id = editIdInput.value;
            const name = editNameInput.value;
            const mobile = editMobileInput.value;
            const birthdate = editDateInput.value;
            const age = editAgeInput.value;
            const notes = Array.from(editNotesContainer.querySelectorAll('div')).map(div => ({
                title: div.querySelector('.note-title').value,
                content: div.querySelector('.note-content').value,
            })).filter(note => note.title || note.content);

            const updatedBirthday = { name, mobile, birthdate, age, notes };

            if (currentUserId && id) {
                database.ref(`users/${currentUserId}/birthdays/${id}`).set(updatedBirthday)
                    .then(() => {
                        editModal.classList.add('hidden');
                    })
                    .catch(error => {
                        console.error("Error updating birthday: ", error);
                    });
            }
        }

        function deleteBirthday(id) {
            if (currentUserId) {
                database.ref(`users/${currentUserId}/birthdays/${id}`).remove()
                    .catch(error => {
                        console.error("Error removing birthday: ", error);
                    });
            }
        }
        
        function deleteContact(id) {
            if (currentUserId) {
                database.ref(`users/${currentUserId}/contacts/${id}`).remove()
                    .catch(error => {
                        console.error("Error removing contact: ", error);
                    });
            }
        }

        function shareBirthday(birthday) {
            let shareText = `Name:${birthday.name}! `;
            if(birthday.birthdate) {
                const nextBday = getNextBirthdayDate(birthday.birthdate);
                shareText += `\n Birth Date:${nextBday.toLocaleDateString('en-US', {  month: 'long', day: 'numeric' })}.`;
            } else if (birthday.age) {
                shareText += `\nThey are ${birthday.age} years old.`;
            }
            
            if (birthday.notes && birthday.notes.length > 0) {
                shareText += "\n\nNotes:";
                birthday.notes.forEach(note => {
                    shareText += `\n- ${note.title}: ${note.content}`;
                });
            }

            if (navigator.share) {
                navigator.share({
                    title: `Birthday Reminder: ${birthday.name}`,
                    text: shareText
                }).catch(error => console.error('Error sharing:', error));
            } else {
                navigator.clipboard.writeText(shareText).then(() => {
                    console.log('Birthday details copied to clipboard!');
                }).catch(err => {
                    console.error('Could not copy text: ', err);
                });
            }
        }
        
        function shareContact(contact) {
            let shareText = `Name: ${contact.name}`;
            if(contact.mobile) {
                shareText += `\nMobile No: ${contact.mobile}`;
            }
            if(contact.phone) {
                shareText += `\nPhone:${contact.phone}`;
            }

            if (navigator.share) {
                navigator.share({
                    title: `Contact: ${contact.name}`,
                    text: shareText
                }).catch(error => console.error('Error sharing:', error));
            } else {
                navigator.clipboard.writeText(shareText).then(() => {
                    console.log('Contact details copied to clipboard!');
                }).catch(err => {
                    console.error('Could not copy text: ', err);
                });
            }
        }

        // --- Data Retrieval and Display ---
        function initializeData() {
            if (currentUserId) {
                // Fetch birthdays
                const birthdaysRef = database.ref(`users/${currentUserId}/birthdays`);
                birthdaysRef.on('value', (snapshot) => {
                    allBirthdays = snapshot.val() || {};
                    const { todayBirthdays, tomorrowBirthdays } = getTodayAndTomorrowBirthdays(allBirthdays);
                    const upcomingBirthdays = getUpcomingBirthdays(allBirthdays);
                    renderBirthdayList('today-list', todayBirthdays);
                    renderBirthdayList('tomorrow-list', tomorrowBirthdays);
                    renderBirthdayList('upcoming-birthdays-list', upcomingBirthdays);
                    renderAllItems(searchInput.value);
                });
                
                // Fetch contacts
                const contactsRef = database.ref(`users/${currentUserId}/contacts`);
                contactsRef.on('value', (snapshot) => {
                    allContacts = snapshot.val() || {};
                    renderAllItems(searchInput.value);
                });
            }
        }

        // --- Auth State Listener ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUserId = user.uid;
                document.getElementById('userName').textContent = user.displayName || 'Guest';
                document.getElementById('userEmail').textContent = user.email || 'guest@example.com';
                document.getElementById('userPhoto').src = user.photoURL || 'https://via.placeholder.com/40';
                document.getElementById('mobileUserName').textContent = user.displayName || 'Guest';
                document.getElementById('mobileUserEmail').textContent = user.email || 'guest@example.com';
                initializeData();
            } else {
                // Redirect to login page or handle signed-out state
                window.location.href = 'index.html';
            }
        });
        
        // Function to run ONCE to import contacts to Firebase
        // UNCOMMENT this section, load the page, then re-comment it.
        /*
        function importContactsToFirebase() {
            if (currentUserId) {
                const contactsRef = database.ref(`users/${currentUserId}/contacts`);
                vcardContacts.forEach(contact => {
                    contactsRef.push(contact)
                        .then(() => console.log(`Contact ${contact.name} imported successfully.`))
                        .catch(error => console.error(`Error importing ${contact.name}: `, error));
                });
            } else {
                console.log("User not logged in. Cannot import contacts.");
            }
        }
        document.addEventListener('DOMContentLoaded', () => {
            auth.onAuthStateChanged(user => {
                if(user) {
                    currentUserId = user.uid;
                    // You can call this function after you log in, just once.
                    // importContactsToFirebase();
                }
            });
        });
        */
        
        // Logout function
        function logout() {
            auth.signOut().then(() => {
                window.location.href = 'index.html';
            }).catch(error => {
                console.error('Sign out error', error);
            });
        }
  </script>
</body>
</html>



